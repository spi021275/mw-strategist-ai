<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multimedia & Workspaces Strategist AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
        }
        .loading { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">
                    Multimedia & Workspaces Strategist AI
                </h1>
                <p class="text-gray-600 mt-1 text-sm sm:text-base">
                    Il tuo partner strategico per spazi di collaborazione perfetti
                </p>
            </div>
            <button id="homeBtn" class="text-sm font-medium text-blue-600 hover:text-blue-800 hidden">
                Torna alla Homepage
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="max-w-7xl mx-auto px-4 py-12">
        <!-- Intro Section -->
        <div id="introSection" class="bg-white rounded-xl shadow-lg p-8">
            <div class="flex items-start mb-6">
                <svg class="w-12 h-12 text-blue-600 mt-1 mr-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                <div class="w-full">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Scegli il tuo modulo</h2>
                    <p class="text-lg text-gray-700 mb-8">Seleziona lo strumento che ti serve per il tuo progetto</p>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Module 1 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-blue-300 transition-all">
                            <div class="flex items-center mb-3">
                                <svg class="w-10 h-10 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                </svg>
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <span class="text-blue-600 font-bold">üìã</span>
                                </div>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Analizza Meeting & Genera Brief DSA</h3>
                            <p class="text-gray-600 mb-4">Analizza appunti del meeting, estrai requisiti e genera brief strutturato per il team DSA con upload di planimetrie e foto.</p>
                            <div class="mb-4 text-sm text-green-600 bg-green-50 p-2 rounded">
                                ‚úÖ Upload trascrizioni Teams ‚Ä¢ ‚úÖ Analisi AI ‚Ä¢ ‚úÖ Brief professionale
                            </div>
                            <button onclick="showPostMeeting()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                                Inizia Analisi
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Module 2 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-cyan-300 transition-all">
                            <div class="flex items-center mb-3">
                                <svg class="w-10 h-10 text-cyan-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                </svg>
                                <div class="w-8 h-8 bg-cyan-100 rounded-full flex items-center justify-center">
                                    <span class="text-cyan-600 font-bold">üè¢</span>
                                </div>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Configuratore Spazi Collaborativi</h3>
                            <p class="text-gray-600 mb-4">Definisci la soluzione tecnologica ottimale per spazi collaborativi basandoti su misure, tipologia e caratteristiche specifiche.</p>
                            <div class="mb-4 text-sm text-orange-600 bg-orange-50 p-2 rounded">
                                üöß In sviluppo ‚Ä¢ üéØ Calcoli automatici ‚Ä¢ ‚öôÔ∏è Configurazioni smart
                            </div>
                            <button onclick="showSpaceWizard()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-cyan-600 hover:bg-cyan-700 text-white font-medium rounded-lg transition-colors">
                                Prova Anteprima
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post Meeting Module -->
        <div id="postMeetingSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Configuratore Spazi Collaborativi</h2>
                <p class="text-gray-600 mb-8">Definisci la soluzione tecnologica ottimale per il tuo spazio</p>
                
                <div class="text-center py-16">
                    <div class="mb-6">
                        <svg class="w-20 h-20 text-cyan-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                        <div class="w-16 h-16 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full mx-auto flex items-center justify-center mb-4">
                            <span class="text-white text-2xl">üöß</span>
                        </div>
                    </div>
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Configuratore in Sviluppo Avanzato</h3>
                    <p class="text-gray-600 max-w-3xl mx-auto mb-8 text-lg">
                        Il configuratore automatico per spazi collaborativi √® in fase di sviluppo finale. 
                        Sar√† disponibile a breve con funzionalit√† complete di calcolo e progettazione intelligente.
                    </p>
                    
                    <div class="grid md:grid-cols-3 gap-6 max-w-4xl mx-auto mt-8">
                        <div class="bg-green-50 p-6 rounded-lg">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <span class="text-green-600 text-xl">üìê</span>
                            </div>
                            <h4 class="font-semibold text-green-800 mb-2">Calcolo Dimensioni</h4>
                            <p class="text-sm text-green-700">Calcolo automatico spazi ottimali in base al numero di partecipanti e tipologia uso</p>
                        </div>
                        
                        <div class="bg-blue-50 p-6 rounded-lg">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <span class="text-blue-600 text-xl">‚öôÔ∏è</span>
                            </div>
                            <h4 class="font-semibold text-blue-800 mb-2">Configurazioni Smart</h4>
                            <p class="text-sm text-blue-700">Raccomandazioni BYOD/MTR automatiche basate su algoritmi di machine learning</p>
                        </div>
                        
                        <div class="bg-purple-50 p-6 rounded-lg">
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <span class="text-purple-600 text-xl">üí∞</span>
                            </div>
                            <h4 class="font-semibold text-purple-800 mb-2">Stima Costi Real-time</h4>
                            <p class="text-sm text-purple-700">Preventivi istantanei con prezzi aggiornati e configurazioni ottimizzate</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 bg-gradient-to-r from-cyan-50 to-blue-50 p-6 rounded-lg max-w-2xl mx-auto">
                        <h4 class="font-semibold text-cyan-800 mb-3">üéØ Prossime Release</h4>
                        <div class="space-y-2 text-sm text-cyan-700">
                            <div class="flex items-center justify-center">
                                <div class="w-2 h-2 bg-cyan-500 rounded-full mr-2"></div>
                                <span>Configuratore Meeting Rooms (Beta Q1 2025)</span>
                            </div>
                            <div class="flex items-center justify-center">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                                <span>Algoritmi AI per ottimizzazione layout (Q2 2025)</span>
                            </div>
                            <div class="flex items-center justify-center">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-2"></div>
                                <span>Integrazione CAD e realt√† aumentata (Q3 2025)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="mt-16 pb-8 text-center text-sm text-gray-500">
        <p>
            Strumento personalizzato per la BU Multimedia & Workspaces di
            <span class="font-semibold text-blue-600">Var Group</span>
        </p>
        <p class="mt-2 text-xs text-gray-400 max-w-2xl mx-auto px-4">
            Sviluppato utilizzando l'expertise della BU e il framework AI del B2B Sales Strategist AI
        </p>
    </div>

    <script>
        console.log("ü§ñ Multimedia & Workspaces AI - Gemini Fixed Version");
        
        // API Configuration
        let GEMINI_API_KEY = "AIzaSyBVS_Q2qKPKnQmbOkRlI1D3PhmhC7jVhmQ";
        
        // Multimedia & Workspaces Context
        const MW_CONTEXT = `
# Var Group - Multimedia & Workspaces Business Unit

## Identit√† e Mission
La BU Multimedia & Workspaces di Var Group si occupa di far comunicare e collaborare al meglio le persone in ogni luogo e contesto. Con oltre 60 anni di esperienza, progettiamo e integriamo spazi di lavoro ibridi e soluzioni di comunicazione, agendo come partner unico per l'intero ciclo di vita del progetto.

## Aree di Competenza Principali
### Microsoft Modern Work
- Suite Microsoft 365 completa per ambiente di lavoro sicuro e intelligente
- Gestione identit√† e accessi (Entra ID)
- Management dispositivi (Intune)
- Produttivit√† (Teams, Exchange, SharePoint)
- Sicurezza (Defender, Sentinel)
- AI personale con Copilot

### Collaboration Solutions
- Telefonia enterprise e videoconferenza
- Piattaforme di collaborazione ibrida
- Partner: Microsoft, Cisco, Poly, Pexip, Logitech, Zoom, Google Cloud

### Allestimenti Workplace
- Progettazione spazi fisici che uniscono architettura e tecnologia
- Focus su qualit√† audio-video e semplicit√† d'uso (BYOD)
- Tipologie: Huddle Room, Meeting Room, Board Room, Training Room, Demo Room

### Soluzioni Tecnologiche Standard
- BYOD (Bring Your Own Device): Connessione dispositivi personali
- MTR (Microsoft Teams Rooms): Sale certificate Microsoft Teams
- Soluzioni Ibride: Combinazione BYOD + MTR per massima flessibilit√†
- Audio: Sistemi di amplificazione, diffusione e acquisizione
- Video: Telecamere, proiettori, monitor, sistemi di switching
- Controllo: Pannelli touch, automazione, gestione centralizzata
        `;

        // State management
        let uploadedFiles = [];
        let transcriptContent = '';
        let generatedBriefContent = '';

        // API Key management
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey && apiKey.startsWith('AIza')) {
                GEMINI_API_KEY = apiKey;
                document.getElementById('apiStatus').innerHTML = '‚úÖ API Key salvata con successo!';
                document.getElementById('apiStatus').className = 'mt-2 text-sm text-green-600';
                document.getElementById('apiStatus').classList.remove('hidden');
                document.getElementById('apiKeyInput').value = '';
            } else {
                document.getElementById('apiStatus').innerHTML = '‚ùå Inserisci una API key valida che inizia con AIza';
                document.getElementById('apiStatus').className = 'mt-2 text-sm text-red-600';
                document.getElementById('apiStatus').classList.remove('hidden');
            }
        }

        // Navigation functions
        function showIntro() {
            document.getElementById('introSection').classList.remove('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.add('hidden');
        }

        function showPostMeeting() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.remove('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        function showSpaceWizard() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.remove('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        // File upload handling for planimetrie/documenti
        document.getElementById('fileUpload').addEventListener('change', function(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                const fileObj = {
                    name: file.name,
                    size: (file.size / 1024 / 1024).toFixed(2) + ' MB',
                    type: file.type || 'application/octet-stream'
                };
                uploadedFiles.push(fileObj);
            });

            updateFileDisplay();
        });

        // Enhanced transcript upload handling with better DOCX support
        document.getElementById('transcriptUpload').addEventListener('change', async function(event) {
            console.log("üìÅ File selezionato per upload trascrizione...");
            const file = event.target.files[0];
            if (!file) return;

            try {
                console.log(`üìÑ Elaborazione file: ${file.name} (${file.type})`);
                let content = '';
                
                // Handle different file types
                if (file.name.toLowerCase().endsWith('.docx')) {
                    console.log("üìù Elaborazione file DOCX con mammoth.js...");
                    // Use mammoth.js for DOCX files
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                    content = result.value;
                    console.log("‚úÖ Testo estratto da DOCX:", content.substring(0, 200) + "...");
                } else if (file.name.toLowerCase().endsWith('.pdf')) {
                    console.log("üìã File PDF rilevato...");
                    // For PDF files, read as text (basic extraction)
                    content = await readFileAsText(file);
                    content = "File PDF caricato: " + file.name + "\n\nNOTA: Per i file PDF √® consigliabile copiare manualmente il testo nelle note del meeting per una migliore analisi.";
                } else {
                    console.log("üìÑ Lettura file di testo...");
                    // For TXT and other text files
                    content = await readFileAsText(file);
                }

                console.log("üßπ Pulizia trascrizione Teams...");
                // Clean up transcript content for Teams format
                content = cleanTeamsTranscript(content);
                transcriptContent = content;
                
                console.log("‚úÖ Trascrizione pulita:", content.substring(0, 300) + "...");
                
                // Show file info
                document.getElementById('transcriptFileName').textContent = file.name;
                document.getElementById('transcriptFile').classList.remove('hidden');
                
                // Show preview
                const preview = content.substring(0, 500) + (content.length > 500 ? '...' : '');
                document.getElementById('transcriptPreviewContent').textContent = preview;
                document.getElementById('transcriptPreview').classList.remove('hidden');
                
                // Add content to meeting notes
                const meetingNotesTextarea = document.getElementById('meetingNotes');
                const currentNotes = meetingNotesTextarea.value;
                const separator = currentNotes ? '\n\n--- TRASCRIZIONE MEETING ---\n' : '--- TRASCRIZIONE MEETING ---\n';
                meetingNotesTextarea.value = currentNotes + separator + content;
                
                console.log("üéâ Trascrizione caricata e aggiunta alle note!");
                
            } catch (error) {
                console.error('‚ùå Errore nel caricamento del file:', error);
                alert('Errore nel caricamento del file: ' + error.message);
            }
        });

        // Clean Teams transcript function
        function cleanTeamsTranscript(rawContent) {
            if (!rawContent) return '';
            
            let cleaned = rawContent;
            
            // Remove image references and metadata
            cleaned = cleaned.replace(/!\[.*?\]\(.*?\)/g, '');
            cleaned = cleaned.replace(/\{width=".*?"\s*height=".*?"\}/g, '');
            cleaned = cleaned.replace(/media\/[a-zA-Z0-9_-]+\.png/g, '');
            
            // Remove timestamp headers
            cleaned = cleaned.replace(/\*\*Trascrizione\*\*\s*\d+.*?\d+:\d+[AP]M/g, '');
            
            // Clean up speaker names and format
            cleaned = cleaned.replace(/\*\*\\\s*/g, '');
            cleaned = cleaned.replace(/\*\*\s*([^*]+)\*\*\s*(\d+:\d+)\\\s*/g, '\n$1 ($2): ');
            cleaned = cleaned.replace(/\*\*\s*([^*]+)\*\*\s*/g, '\n$1: ');
            
            // Remove extra asterisks and formatting
            cleaned = cleaned.replace(/\*+/g, '');
            cleaned = cleaned.replace(/\\\s*/g, ' ');
            
            // Clean up multiple newlines and spaces
            cleaned = cleaned.replace(/\n\s*\n\s*\n/g, '\n\n');
            cleaned = cleaned.replace(/[ \t]+/g, ' ');
            
            // Remove "trascrizione avviata/arrestata" lines
            cleaned = cleaned.replace(/.*trascrizione (avviata|arrestata).*/gi, '');
            
            return cleaned.trim();
        }

        // Read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                
                reader.onerror = function() {
                    reject(new Error('Errore nella lettura del file'));
                };
                
                reader.readAsText(file, 'UTF-8');
            });
        }

        // Remove transcript
        function removeTranscript() {
            transcriptContent = '';
            document.getElementById('transcriptFile').classList.add('hidden');
            document.getElementById('transcriptPreview').classList.add('hidden');
            document.getElementById('transcriptUpload').value = '';
            
            // Remove from meeting notes
            const meetingNotesTextarea = document.getElementById('meetingNotes');
            const content = meetingNotesTextarea.value;
            const cleanedContent = content.replace(/\n*--- TRASCRIZIONE MEETING ---\n[\s\S]*$/, '');
            meetingNotesTextarea.value = cleanedContent;
        }

        function updateFileDisplay() {
            const uploadedFilesDiv = document.getElementById('uploadedFiles');
            const fileList = document.getElementById('fileList');
            
            if (uploadedFiles.length > 0) {
                uploadedFilesDiv.classList.remove('hidden');
                fileList.innerHTML = uploadedFiles.map((file, index) => `
                    <div class="flex items-center justify-between bg-gray-100 p-3 rounded-lg">
                        <div>
                            <span class="font-medium">${file.name}</span>
                            <span class="text-sm text-gray-500 ml-2">(${file.size})</span>
                        </div>
                        <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `).join('');
            } else {
                uploadedFilesDiv.classList.add('hidden');
            }
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileDisplay();
        }

        // Form validation
        function canGenerateBrief() {
            const clientName = document.getElementById('clientName').value.trim();
            const meetingNotes = document.getElementById('meetingNotes').value.trim();
            const numberOfRooms = document.getElementById('numberOfRooms').value.trim();
            
            return clientName && meetingNotes && numberOfRooms && GEMINI_API_KEY;
        }

        // Get selected values from checkboxes
        function getSelectedValues(containerId) {
            const container = document.getElementById(containerId);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Generate brief using Gemini API
        async function generateBrief() {
            console.log("üéØ Inizio generazione brief con Gemini...");
            
            if (!GEMINI_API_KEY) {
                alert('‚ö†Ô∏è Inserisci prima la tua Gemini API key nel campo in alto!');
                return;
            }
            
            if (!canGenerateBrief()) {
                alert('Per favore compila almeno: Nome Cliente, Numero Sale/Spazi e Note del Meeting');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            const originalText = generateBtn.innerHTML;
            
            // Show loading state
            generateBtn.innerHTML = `
                <svg class="w-5 h-5 mr-3 loading" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Generazione in corso...
            `;
            generateBtn.disabled = true;

            try {
                // Collect form data
                const formData = {
                    clientName: document.getElementById('clientName').value,
                    contactPerson: document.getElementById('contactPerson').value,
                    meetingDate: document.getElementById('meetingDate').value,
                    numberOfRooms: document.getElementById('numberOfRooms').value,
                    budget: document.getElementById('budget').value,
                    spaceTypes: getSelectedValues('spaceTypes'),
                    techRequirements: getSelectedValues('techRequirements'),
                    meetingNotes: document.getElementById('meetingNotes').value,
                    timeline: document.getElementById('timeline').value,
                    specialRequirements: document.getElementById('specialRequirements').value
                };

                console.log("üìã Dati raccolti:", formData);

                const prompt = `Agisci come un Senior Technical Consultant di Var Group - Multimedia & Workspaces. 

CONTESTO AZIENDALE:
${MW_CONTEXT}

DATI DEL MEETING E REQUISITI CLIENTE:
- Cliente: ${formData.clientName}
- Contatto: ${formData.contactPerson}
- Data Meeting: ${formData.meetingDate}
- Numero Sale/Spazi: ${formData.numberOfRooms}
- Tipologie Spazi: ${formData.spaceTypes.join(', ')}
- Requisiti Tecnologici: ${formData.techRequirements.join(', ')}
- Budget Indicativo: ${formData.budget}
- Timeline: ${formData.timeline}
- Note del Meeting: ${formData.meetingNotes.substring(0, 3000)}
- Requisiti Speciali: ${formData.specialRequirements}
- File Allegati: ${uploadedFiles.map(f => f.name).join(', ')}

TASK: Genera un brief strutturato e professionale per il team DSA (Design & Solution Architecture) che contenga:

1. EXECUTIVE SUMMARY - Sintesi del progetto e obiettivi del cliente
2. ANALISI REQUISITI - Requisiti funzionali estratti, Requisiti tecnici identificati, Vincoli e criticit√† emerse
3. SPECIFICHE SPAZI - Dettaglio per ogni tipologia di spazio richiesta, Numero partecipanti previsti, Funzionalit√† specifiche
4. INDICAZIONI TECNOLOGICHE - Soluzioni tecnologiche da valutare, Integrazioni richieste, Standard di qualit√†
5. DELIVERABLE RICHIESTI AL DSA - Tech Annex dettagliato, Economics e pricing, Timeline implementazione
6. NEXT STEPS - Azioni immediate per il DSA, Informazioni aggiuntive da raccogliere, Milestone del progetto

Fornisci il brief in formato HTML professionale, strutturato e pronto per essere condiviso con il team DSA.`;

                console.log("üì§ Invio prompt a Gemini...");
                const response = await callGeminiAPI(prompt);
                
                // Show generated brief
                generatedBriefContent = response;
                document.getElementById('briefContent').innerHTML = response;
                document.getElementById('postMeetingForm').classList.add('hidden');
                document.getElementById('generatedBrief').classList.remove('hidden');
                document.getElementById('generatedBrief').classList.add('fade-in');

                console.log("‚úÖ Brief generato con successo!");

            } catch (error) {
                console.error('‚ùå Errore completo:', error);
                alert('Errore nella generazione del brief: ' + error.message);
            } finally {
                // Restore button
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        // Call Gemini API with improved error handling
        async function callGeminiAPI(prompt) {
            console.log("ü§ñ [GEMINI] Chiamata API...");
            
            const modelName = "gemini-1.5-flash"; // Modello pi√π stabile e veloce
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`;

            const requestBody = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    maxOutputTokens: 4096,
                    temperature: 0.7,
                }
            };

            try {
                console.log('üì° [GEMINI] Invio richiesta...');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });
                
                console.log(`üìä [GEMINI] Status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå [GEMINI] Errore:', errorText);
                    throw new Error(`Gemini API Error (${response.status}): ${errorText}`);
                }

                const result = await response.json();
                console.log('‚úÖ [GEMINI] Risposta ricevuta!');
                
                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    let rawText = result.candidates[0].content.parts[0].text;
                    return rawText.replace(/^\s*```(html)?\n?/, '').replace(/\n?```\s*$/, '');
                } else {
                    console.error('‚ùå [GEMINI] Formato non valido:', result);
                    throw new Error("Risposta Gemini non nel formato atteso.");
                }
            } catch (error) {
                console.error('‚ùå [GEMINI] Errore chiamata:', error);
                throw error;
            }
        }

        // Copy brief to clipboard
        function copyBrief() {
            if (!generatedBriefContent) return;
            
            const textArea = document.createElement("textarea");
            textArea.value = generatedBriefContent.trim();
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                // Change button text temporarily
                const copyBtn = event.target.closest('button');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = `
                    <svg class="w-4 h-4 mr-1.5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Copiato!
                `;
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                alert('Impossibile copiare il testo.');
            }
            
            document.body.removeChild(textArea);
        }

        // Reset form
        function resetForm() {
            // Reset all form fields
            document.getElementById('clientName').value = '';
            document.getElementById('contactPerson').value = '';
            document.getElementById('meetingDate').value = '';
            document.getElementById('numberOfRooms').value = '';
            document.getElementById('budget').value = '';
            document.getElementById('meetingNotes').value = '';
            document.getElementById('timeline').value = '';
            document.getElementById('specialRequirements').value = '';
            
            // Reset checkboxes
            document.querySelectorAll('#spaceTypes input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('#techRequirements input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            // Reset file uploads
            uploadedFiles = [];
            updateFileDisplay();
            
            // Reset transcript
            transcriptContent = '';
            document.getElementById('transcriptFile').classList.add('hidden');
            document.getElementById('transcriptPreview').classList.add('hidden');
            document.getElementById('transcriptUpload').value = '';
            
            // Show form, hide brief
            document.getElementById('postMeetingForm').classList.remove('hidden');
            document.getElementById('generatedBrief').classList.add('hidden');
            
            generatedBriefContent = '';
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üéâ App Gemini Fixed inizializzata!");
            // Set default view
            showIntro();
            
            // Add click handler for home button
            document.getElementById('homeBtn').addEventListener('click', showIntro);
        });
    </script>
</body>
</html>1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Analizza Meeting & Genera Brief DSA</h2>
                <p class="text-gray-600 mb-8">Trasforma i tuoi appunti del meeting in un brief tecnico strutturato per il team DSA</p>
                
                <!-- API Key Configuration -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8">
                    <h3 class="text-lg font-semibold text-blue-900 mb-3">üîë Configurazione API Gemini</h3>
                    <div class="flex gap-4">
                        <input type="password" id="apiKeyInput" class="flex-1 p-2 border border-blue-300 rounded" placeholder="Inserisci la tua nuova Gemini API key">
                        <button onclick="saveApiKey()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Salva</button>
                    </div>
                    <p class="text-sm text-blue-700 mt-2">
                        üìå Crea una nuova API key su <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline">Google AI Studio</a>
                    </p>
                    <div id="apiStatus" class="mt-2 text-sm hidden"></div>
                </div>
                
                <div id="postMeetingForm" class="space-y-8">
                    <!-- Dati Base Cliente -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Cliente *</label>
                            <input type="text" id="clientName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Es. JBT Corporation">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contatto Principale</label>
                            <input type="text" id="contactPerson" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Es. Mario Rossi - IT Manager">
                        </div>
                    </div>

                    <!-- Dettagli Meeting -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Meeting</label>
                            <input type="date" id="meetingDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Numero Sale/Spazi *</label>
                            <input type="text" id="numberOfRooms" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Es. 3 meeting room + 1 auditorium">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Budget Indicativo</label>
                            <input type="text" id="budget" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Es. 50k-100k‚Ç¨">
                        </div>
                    </div>

                    <!-- Tipologie Spazi -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Tipologie di Spazi</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="spaceTypes">
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Meeting Room" class="mr-3 text-blue-600">
                                <span class="text-sm">Meeting Room</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Huddle Room" class="mr-3 text-blue-600">
                                <span class="text-sm">Huddle Room</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Board Room" class="mr-3 text-blue-600">
                                <span class="text-sm">Board Room</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Auditorium" class="mr-3 text-blue-600">
                                <span class="text-sm">Auditorium</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Training Room" class="mr-3 text-blue-600">
                                <span class="text-sm">Training Room</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Ufficio Ibrido" class="mr-3 text-blue-600">
                                <span class="text-sm">Ufficio Ibrido</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Media Room" class="mr-3 text-blue-600">
                                <span class="text-sm">Media Room</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Control Room" class="mr-3 text-blue-600">
                                <span class="text-sm">Control Room</span>
                            </label>
                        </div>
                    </div>

                    <!-- Requisiti Tecnologici -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Requisiti Tecnologici</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="techRequirements">
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="BYOD" class="mr-3 text-blue-600">
                                <span class="text-sm">BYOD</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Microsoft Teams Rooms (MTR)" class="mr-3 text-blue-600">
                                <span class="text-sm">Microsoft Teams Rooms (MTR)</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Videoconferenza" class="mr-3 text-blue-600">
                                <span class="text-sm">Videoconferenza</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Audio Professionale" class="mr-3 text-blue-600">
                                <span class="text-sm">Audio Professionale</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Digital Signage" class="mr-3 text-blue-600">
                                <span class="text-sm">Digital Signage</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Controllo Centralizzato" class="mr-3 text-blue-600">
                                <span class="text-sm">Controllo Centralizzato</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Streaming/Recording" class="mr-3 text-blue-600">
                                <span class="text-sm">Streaming/Recording</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Telepresence" class="mr-3 text-blue-600">
                                <span class="text-sm">Telepresence</span>
                            </label>
                        </div>
                    </div>

                    <!-- Note Meeting con Upload Trascrizione -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Note e Appunti del Meeting *</label>
                        <div class="space-y-4">
                            <textarea id="meetingNotes" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Incolla qui tutti gli appunti del meeting, requisiti emersi, problematiche discusse, aspettative del cliente..."></textarea>
                            
                            <!-- Upload Trascrizione Teams -->
                            <div class="border-t pt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Oppure carica trascrizione Teams/call</label>
                                <div onclick="document.getElementById('transcriptUpload').click()" class="flex items-center justify-center w-full h-20 border-2 border-blue-300 border-dashed rounded-lg bg-blue-50 hover:bg-blue-100 cursor-pointer transition-colors">
                                    <svg class="w-6 h-6 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                    </svg>
                                    <span class="text-sm text-blue-700">Carica trascrizione Teams (.txt, .docx, .pdf)</span>
                                </div>
                                <input type="file" id="transcriptUpload" class="hidden" accept=".txt,.docx,.pdf,.doc">
                                <div id="transcriptFile" class="mt-2 hidden">
                                    <div class="flex items-center justify-between bg-blue-100 p-3 rounded-lg">
                                        <div class="flex items-center">
                                            <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <span id="transcriptFileName" class="font-medium text-blue-800"></span>
                                        </div>
                                        <button onclick="removeTranscript()" class="text-red-500 hover:text-red-700">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div id="transcriptPreview" class="mt-2 hidden">
                                    <div class="bg-gray-50 p-3 rounded-lg max-h-40 overflow-y-auto">
                                        <p class="text-xs text-gray-600 mb-2">Anteprima trascrizione estratta:</p>
                                        <div id="transcriptPreviewContent" class="text-sm text-gray-800"></div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Il contenuto del file verr√† automaticamente aggiunto alle note del meeting per l'analisi AI</p>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline e Requisiti Speciali -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Timeline Progetto</label>
                            <input type="text" id="timeline" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Es. Implementazione entro Q2 2024">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Requisiti Speciali</label>
                            <input type="text" id="specialRequirements" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Es. Certificazioni, integrazione con sistemi esistenti...">
                        </div>
                    </div>

                    <!-- Upload File -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Planimetrie, Foto e Documenti</label>
                        <div onclick="document.getElementById('fileUpload').click()" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg bg-gray-50 hover:bg-gray-100 cursor-pointer transition-colors">
                            <svg class="w-10 h-10 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <span class="text-sm text-gray-600">Trascina qui o clicca per caricare</span>
                            <span class="text-xs text-gray-500 mt-1">DWG, PDF, immagini, documenti</span>
                        </div>
                        <input type="file" multiple id="fileUpload" class="hidden" accept=".dwg,.pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.txt,.zip,.rar">
                        <div id="uploadedFiles" class="mt-4 space-y-2 hidden">
                            <p class="font-semibold text-sm">File caricati:</p>
                            <div id="fileList"></div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="text-center">
                        <button onclick="generateBrief()" id="generateBtn" class="inline-flex items-center px-8 py-3 bg-blue-600 text-white font-medium text-lg rounded-lg hover:bg-blue-700 shadow-lg">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            Genera Brief per DSA
                        </button>
                    </div>
                </div>

                <!-- Generated Brief Display -->
                <div id="generatedBrief" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-800">Brief Generato per il Team DSA</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="copyBrief()" class="inline-flex items-center px-3 py-1.5 bg-gray-200 text-gray-700 text-xs font-medium rounded-lg hover:bg-gray-300">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Copia Brief
                            </button>
                            <button onclick="resetForm()" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Nuova Analisi
                            </button>
                        </div>
                    </div>
                    
                    <div id="briefContent" class="prose prose-lg max-w-none bg-gray-50 p-6 rounded-lg border">
                        <!-- Generated content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Space Wizard Module -->
        <div id="spaceWizardSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-
