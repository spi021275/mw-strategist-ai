<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multimedia & Workspaces Strategist AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <!-- Libreria XLSX aggiunta per il Modulo 3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
        }
        .loading { animation: spin 1.5s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        /* Stili per la preview del brief del Modulo 1 */
        .prose h1, .prose h2, .prose h3 { color: #1e3a8a; margin-top: 1.25em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.75rem; margin-top: 0.5em; }
        .prose table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        .prose th, .prose td { border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; }
        .prose th { background-color: #eff6ff; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">
                    Multimedia & Workspaces Strategist AI
                </h1>
                <p class="text-gray-600 mt-1 text-sm sm:text-base">
                    Il tuo partner strategico per spazi di collaborazione perfetti
                </p>
            </div>
            <button id="homeBtn" class="text-sm font-medium text-blue-600 hover:text-blue-800 hidden">
                Torna alla Homepage
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="max-w-7xl mx-auto px-4 py-12">
        <!-- Intro Section -->
        <div id="introSection" class="bg-white rounded-xl shadow-lg p-8">
            <div class="flex items-start mb-6">
                <svg class="w-12 h-12 text-blue-600 mt-1 mr-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                <div class="w-full">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Scegli il tuo modulo</h2>
                    <p class="text-lg text-gray-700 mb-8">Seleziona lo strumento che ti serve per il tuo progetto</p>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Module 1 -->
                         <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-blue-300 transition-all">
                            <svg class="w-10 h-10 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Analizza Meeting & Genera Brief DSA</h3>
                            <p class="text-gray-600 mb-4">Analizza appunti del meeting, estrai requisiti e genera brief strutturato per il team DSA sfruttando l'expertise di 51 anni, partnership certificate e soluzioni proprietarie (Spacebooking, Agrid Welcome/Bank).</p>
                            <button onclick="showPostMeeting()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Module 2 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-blue-300 transition-all">
                            <svg class="w-10 h-10 text-cyan-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Wizard Spazi Collaborativi</h3>
                            <p class="text-gray-600 mb-4">Definisci la soluzione tecnologica ottimale per spazi collaborativi basandoti su misure, tipologia e caratteristiche.</p>
                            <button onclick="showSpaceWizard()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-cyan-600 hover:bg-cyan-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Module 3 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-green-300 transition-all">
                            <svg class="w-10 h-10 text-green-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Generatore Offerte Economiche</h3>
                            <p class="text-gray-600 mb-4">Carica un file di Analisi Economica e genera un'offerta formattata pronta all'uso.</p>
                            <button onclick="showFileGenerator()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post Meeting Module -->
        <div id="postMeetingSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Analizza Meeting & Genera Brief DSA</h2>
                <p class="text-gray-600 mb-8">Trasforma i tuoi appunti del meeting in un brief tecnico strutturato per il team DSA utilizzando l'expertise completa della BU (51 anni esperienza, 823M€ fatturato, 3.850 persone)</p>
                
                <div id="postMeetingForm" class="space-y-8">
                    <!-- Dati Base Cliente -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Cliente *</label>
                            <input type="text" id="clientName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Es. JBT Corporation">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contatto Principale</label>
                            <input type="text" id="contactPerson" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Es. Mario Rossi - IT Manager">
                        </div>
                    </div>

                    <!-- Dettagli Meeting -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Meeting</label>
                            <input type="date" id="meetingDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Numero Sale/Spazi *</label>
                            <input type="text" id="numberOfRooms" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Es. 3 meeting room + 1 auditorium">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Budget Indicativo</label>
                            <input type="text" id="budget" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Es. 50k-100k€">
                        </div>
                    </div>

                    <!-- Tipologie Spazi -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Tipologie di Spazi</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="spaceTypes">
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Meeting Room" class="mr-3 text-blue-600">
                                <span class="text-sm">Meeting Room</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Huddle Room" class="mr-3 text-blue-600">
                                <span class="text-sm">Huddle Room</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Board Room" class="mr-3 text-blue-600">
                                <span class="text-sm">Board Room</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Auditorium" class="mr-3 text-blue-600">
                                <span class="text-sm">Auditorium</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Training Room" class="mr-3 text-blue-600">
                                <span class="text-sm">Training Room</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Ufficio Ibrido" class="mr-3 text-blue-600">
                                <span class="text-sm">Ufficio Ibrido</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Media Room" class="mr-3 text-blue-600">
                                <span class="text-sm">Media Room</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Control Room" class="mr-3 text-blue-600">
                                <span class="text-sm">Control Room</span>
                            </label>
                        </div>
                    </div>

                    <!-- Requisiti Tecnologici -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Requisiti Tecnologici</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="techRequirements">
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="BYOD" class="mr-3 text-blue-600">
                                <span class="text-sm">BYOD</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Microsoft Teams Rooms (MTR)" class="mr-3 text-blue-600">
                                <span class="text-sm">Microsoft Teams Rooms (MTR)</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Videoconferenza" class="mr-3 text-blue-600">
                                <span class="text-sm">Videoconferenza</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Audio Professionale" class="mr-3 text-blue-600">
                                <span class="text-sm">Audio Professionale</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Digital Signage" class="mr-3 text-blue-600">
                                <span class="text-sm">Digital Signage</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Controllo Centralizzato" class="mr-3 text-blue-600">
                                <span class="text-sm">Controllo Centralizzato</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Streaming/Recording" class="mr-3 text-blue-600">
                                <span class="text-sm">Streaming/Recording</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" value="Telepresence" class="mr-3 text-blue-600">
                                <span class="text-sm">Telepresence</span>
                            </label>
                        </div>
                    </div>

                    <!-- Note Meeting con Upload Trascrizione -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Note e Appunti del Meeting *</label>
                        <div class="space-y-4">
                            <textarea id="meetingNotes" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Incolla qui tutti gli appunti del meeting, requisiti emersi, problematiche discusse, aspettative del cliente..."></textarea>
                            
                            <!-- Upload Trascrizione Teams -->
                            <div class="border-t pt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Oppure carica trascrizione Teams/call</label>
                                <div onclick="document.getElementById('transcriptUpload').click()" class="flex items-center justify-center w-full h-20 border-2 border-blue-300 border-dashed rounded-lg bg-blue-50 hover:bg-blue-100 cursor-pointer transition-colors">
                                    <svg class="w-6 h-6 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                    </svg>
                                    <span class="text-sm text-blue-700">Carica trascrizione Teams (.txt, .docx, .pdf)</span>
                                </div>
                                <input type="file" id="transcriptUpload" class="hidden" accept=".txt,.docx,.pdf,.doc">
                                <div id="transcriptFile" class="mt-2 hidden">
                                    <div class="flex items-center justify-between bg-blue-100 p-3 rounded-lg">
                                        <div class="flex items-center">
                                            <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <span id="transcriptFileName" class="font-medium text-blue-800"></span>
                                        </div>
                                        <button onclick="removeTranscript()" class="text-red-500 hover:text-red-700">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div id="transcriptPreview" class="mt-2 hidden">
                                    <div class="bg-gray-50 p-3 rounded-lg max-h-40 overflow-y-auto">
                                        <p class="text-xs text-gray-600 mb-2">Anteprima trascrizione estratta:</p>
                                        <div id="transcriptPreviewContent" class="text-sm text-gray-800"></div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Il contenuto del file verrà automaticamente aggiunto alle note del meeting per l'analisi AI</p>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline e Requisiti Speciali -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Timeline Progetto</label>
                            <input type="text" id="timeline" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Es. Implementazione entro Q2 2024">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Requisiti Speciali</label>
                            <input type="text" id="specialRequirements" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Es. Certificazioni, integrazione con sistemi esistenti...">
                        </div>
                    </div>

                    <!-- Upload File -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Planimetrie, Foto e Documenti</label>
                        <div onclick="document.getElementById('fileUpload').click()" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg bg-gray-50 hover:bg-gray-100 cursor-pointer transition-colors">
                            <svg class="w-10 h-10 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <span class="text-sm text-gray-600">Trascina qui o clicca per caricare</span>
                            <span class="text-xs text-gray-500 mt-1">DWG, PDF, immagini, documenti</span>
                        </div>
                        <input type="file" multiple id="fileUpload" class="hidden" accept=".dwg,.pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.txt,.zip,.rar">
                        <div id="uploadedFiles" class="mt-4 space-y-2 hidden">
                            <p class="font-semibold text-sm">File caricati:</p>
                            <div id="fileList"></div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="text-center">
                        <button onclick="generateBrief()" id="generateBtn" class="inline-flex items-center px-8 py-3 bg-blue-600 text-white font-medium text-lg rounded-lg hover:bg-blue-700 shadow-lg">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            Genera Brief per DSA
                        </button>
                    </div>
                </div>

                <!-- Generated Brief Display -->
                <div id="generatedBrief" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-800">Brief Generato per il Team DSA</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="copyBrief()" class="inline-flex items-center px-3 py-1.5 bg-gray-200 text-gray-700 text-xs font-medium rounded-lg hover:bg-gray-300">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Copia Brief
                            </button>
                            <button onclick="resetForm()" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Nuova Analisi
                            </button>
                        </div>
                    </div>
                    
                    <div id="briefContent" class="prose prose-lg max-w-none bg-gray-50 p-6 rounded-lg border">
                        <!-- Generated content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Space Wizard Module -->
<div id="spaceWizardSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Wizard Spazi Collaborativi</h2>
                <p class="text-gray-600 mb-8">Configura la soluzione tecnologica ottimale per il tuo spazio con analisi AI automatica da foto/planimetrie o inserimento manuale</p>
                
                <!-- Wizard Form -->
                <div id="wizardForm" class="space-y-8">
                    
                    <!-- Dati Base Progetto -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Cliente *</label>
                            <input type="text" id="wizardClientName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="Es. JBT Corporation">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Spazio *</label>
                            <input type="text" id="wizardSpaceName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="Es. Meeting Room Piano 2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Budget Stimato</label>
                            <input type="text" id="wizardBudget" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="Es. 15k€">
                        </div>
                    </div>

                    <!-- Modalità Videoconferenza -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Modalità Videoconferenza Preferita *</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="vcMode" value="BYOD" class="mr-3 text-cyan-600">
                                <span class="text-sm font-medium">BYOD</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="vcMode" value="MTR" class="mr-3 text-cyan-600">
                                <span class="text-sm font-medium">Microsoft Teams Rooms</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="vcMode" value="ZOOM" class="mr-3 text-cyan-600">
                                <span class="text-sm font-medium">Zoom Rooms</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="vcMode" value="GOOGLE MEET" class="mr-3 text-cyan-600">
                                <span class="text-sm font-medium">Google Meet</span>
                            </label>
                        </div>
                    </div>

                    <!-- Metodo Input Dati -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Come vuoi inserire i dati dello spazio? *</label>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div id="manualInput" class="border rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors" onclick="selectInputMethod('manual')">
                                <div class="flex items-center mb-3">
                                    <input type="radio" id="radioManual" name="inputMethod" value="manual" class="mr-3 text-cyan-600">
                                    <svg class="w-6 h-6 text-cyan-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    <span class="font-medium">Inserimento Manuale</span>
                                </div>
                                <p class="text-sm text-gray-600">Inserisci manualmente dimensioni, capacità e caratteristiche dello spazio</p>
                            </div>
                            
                            <div id="uploadInput" class="border rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors" onclick="selectInputMethod('upload')">
                                <div class="flex items-center mb-3">
                                    <input type="radio" id="radioUpload" name="inputMethod" value="upload" class="mr-3 text-cyan-600">
                                    <svg class="w-6 h-6 text-cyan-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="font-medium">Analisi AI da Foto/Planimetria</span>
                                </div>
                                <p class="text-sm text-gray-600">Carica foto o planimetrie per analisi automatica con AI</p>
                            </div>
                        </div>
                    </div>

                    <!-- Campi Inserimento Manuale -->
                    <div id="manualFields" class="hidden space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-800 mb-4">Inserimento Manuale Dimensioni</h4>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Capacità Persone *</label>
                                    <input type="number" id="roomCapacity" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="Es. 8" min="1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Metri Quadri</label>
                                    <input type="number" id="roomSqm" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="Es. 25" step="0.1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Altezza (m)</label>
                                    <input type="number" id="roomHeight" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="2.7" step="0.1" value="2.7">
                                </div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Larghezza (m)</label>
                                    <input type="number" id="roomWidth" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="Es. 5.0" step="0.1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Lunghezza (m)</label>
                                    <input type="number" id="roomLength" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="Es. 5.0" step="0.1">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Note Aggiuntive</label>
                                <textarea id="roomNotes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="Caratteristiche particolari, vincoli, presenza monitor esistenti..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Files e Analisi AI -->
                    <div id="uploadFields" class="hidden space-y-6">
                        <div class="bg-cyan-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-800 mb-4">Carica File per Analisi AI</h4>
                            
                            <div class="grid md:grid-cols-2 gap-6">
                                <!-- Upload Foto -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Foto dello Spazio</label>
                                    <div onclick="document.getElementById('photoUpload').click()" class="flex flex-col items-center justify-center h-32 border-2 border-cyan-300 border-dashed rounded-lg bg-cyan-50 hover:bg-cyan-100 cursor-pointer transition-colors">
                                        <svg class="w-8 h-8 text-cyan-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        <span class="text-sm text-cyan-700">Carica Foto</span>
                                        <span class="text-xs text-cyan-600">.jpg, .jpeg, .png</span>
                                    </div>
                                    <input type="file" id="photoUpload" class="hidden" accept=".jpg,.jpeg,.png,.tiff">
                                </div>

                                <!-- Upload Planimetria -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Planimetria</label>
                                    <div onclick="document.getElementById('planUpload').click()" class="flex flex-col items-center justify-center h-32 border-2 border-cyan-300 border-dashed rounded-lg bg-cyan-50 hover:bg-cyan-100 cursor-pointer transition-colors">
                                        <svg class="w-8 h-8 text-cyan-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span class="text-sm text-cyan-700">Carica Planimetria</span>
                                        <span class="text-xs text-cyan-600">.dwg, .pdf, .jpg</span>
                                    </div>
                                    <input type="file" id="planUpload" class="hidden" accept=".dwg,.pdf,.jpg,.jpeg,.png">
                                </div>
                            </div>

                            <!-- File Caricati -->
                            <div id="uploadedSpaceFiles" class="mt-4 hidden">
                                <p class="font-semibold text-sm text-gray-700 mb-2">File caricati:</p>
                                <div id="spaceFileList" class="space-y-2"></div>
                            </div>

                            <!-- Risultato Analisi AI -->
                            <div id="aiAnalysisResult" class="mt-4 hidden">
                                <div class="bg-green-100 p-4 rounded-lg border border-green-300">
                                    <h5 class="font-medium text-green-800 mb-2">Analisi AI Completata</h5>
                                    <div id="aiAnalysisContent" class="text-sm text-green-700"></div>
                                    <p class="text-xs text-green-600 mt-2">I dati sono stati compilati automaticamente nei campi sottostanti. Puoi modificarli se necessario.</p>
                                </div>
                            </div>

                            <!-- Campi Compilati da AI (sempre visibili per modifica) -->
                            <div class="mt-6 grid md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Capacità Persone *</label>
                                    <input type="number" id="roomCapacityAI" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="Compilato da AI" min="1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Metri Quadri</label>
                                    <input type="number" id="roomSqmAI" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="Compilato da AI" step="0.1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Altezza (m)</label>
                                    <input type="number" id="roomHeightAI" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="2.7" step="0.1" value="2.7">
                                </div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Larghezza (m)</label>
                                    <input type="number" id="roomWidthAI" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="Compilato da AI" step="0.1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Lunghezza (m)</label>
                                    <input type="number" id="roomLengthAI" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500" placeholder="Compilato da AI" step="0.1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configurazioni Aggiuntive -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Configurazioni Aggiuntive</label>
                        <div class="grid md:grid-cols-3 gap-3">
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" id="hasExistingMonitor" class="mr-3 text-cyan-600">
                                <span class="text-sm">Monitor/TV esistente</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" id="needsWirelessSharing" class="mr-3 text-cyan-600">
                                <span class="text-sm">Condivisione wireless</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="checkbox" id="acousticChallenges" class="mr-3 text-cyan-600">
                                <span class="text-sm">Sfide acustiche</span>
                            </label>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="text-center">
                        <button onclick="generateSpaceProposal()" id="wizardGenerateBtn" class="inline-flex items-center px-8 py-3 bg-cyan-600 text-white font-medium text-lg rounded-lg hover:bg-cyan-700 shadow-lg">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Genera Proposta Configurazione
                        </button>
                    </div>
                </div>

                <!-- Generated Proposal Display -->
                <div id="generatedProposal" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-800">Proposta di Configurazione Generata</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="downloadProposalWord()" class="inline-flex items-center px-3 py-1.5 bg-green-600 text-white text-xs font-medium rounded-lg hover:bg-green-700">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download Word
                            </button>
                            <button onclick="copyBrief()" class="inline-flex items-center px-3 py-1.5 bg-gray-200 text-gray-700 text-xs font-medium rounded-lg hover:bg-gray-300">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Copia Proposta
                            </button>
                            <button onclick="resetWizard()" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Nuova Configurazione
                            </button>
                        </div>
                    </div>
                    
                    <div id="proposalContent" class="prose prose-lg max-w-none bg-gray-50 p-6 rounded-lg border">
                        <!-- Generated content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
     <!-- File Generator Module -->
        <div id="fileGeneratorSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Torna alla Homepage
                </button>
                
                <div id="fileGeneratorForm" class="space-y-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Generazione Offerta Economica</h2>
                    <p class="text-gray-600 -mt-6">Carica il file Excel "Analisi Economica" per generare la tabella riepilogativa.</p>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div><label for="fileGenClientName" class="block text-sm font-medium text-gray-700 mb-2">Nome Cliente *</label><input type="text" id="fileGenClientName" class="w-full p-3 border border-gray-300 rounded-lg"></div>
                        <div><label for="projectCode" class="block text-sm font-medium text-gray-700 mb-2">Codice Progetto / Riferimento</label><input type="text" id="projectCode" class="w-full p-3 border border-gray-300 rounded-lg"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">File Analisi Economica DSA *</label>
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <div onclick="document.getElementById('analysisUpload').click()" class="flex flex-col items-center justify-center h-32 border-2 border-blue-300 border-dashed rounded-lg bg-white hover:bg-blue-50 cursor-pointer"><svg class="w-10 h-10 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg><span class="text-sm text-blue-700">Clicca per caricare</span><span class="text-xs text-blue-600 mt-1">.xlsx, .xls</span></div>
                            <input type="file" id="analysisUpload" class="hidden" accept=".xlsx,.xlsm,.xls" onchange="handleAnalysisUpload(event)">
                            <div id="uploadedAnalysisFile" class="mt-4 hidden"><div class="flex items-center justify-between bg-blue-100 p-3 rounded-lg"><div class="flex items-center min-w-0"><svg class="w-5 h-5 text-blue-600 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span id="analysisFileName" class="font-medium text-blue-800 truncate"></span></div><button onclick="removeAnalysisFile()" class="text-red-500 hover:text-red-700 ml-4 flex-shrink-0"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg></button></div></div>
                        </div>
                    </div>
                    <div class="text-center pt-4"><button type="button" onclick="generateFiles()" id="fileGenerateBtn" class="inline-flex items-center px-8 py-3 bg-blue-600 text-white font-medium text-lg rounded-lg disabled:opacity-50" disabled>Genera Offerta</button></div>
                </div>
                <div id="generatedFiles" class="hidden space-y-6"><h3 class="text-2xl font-bold text-gray-800">Offerta Generata</h3><div id="filesList"></div><div id="filesPreview"></div><div class="text-center"><button onclick="resetFileGenerator()" class="inline-flex items-center px-4 py-2 bg-gray-300 text-gray-800 rounded-lg"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>Torna Indietro</button></div></div>
            </div>
        </div>
        <!-- RESULTS SECTION -->
        <div id="generatedFiles" class="hidden space-y-6">
            <h3 class="text-2xl font-bold text-gray-800">Offerta Generata</h3>
            <div id="filesList"></div>
            <div id="filesPreview"></div>
            <div class="text-center">
                <button onclick="resetFileGenerator()" class="inline-flex items-center px-4 py-2 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Torna Indietro (Nuova Offerta)
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Footer -->
<div class="mt-16 pb-8 text-center text-sm text-gray-500">
        <p>
            Strumento specializzato per la BU Multimedia & Workspaces di
            <span class="font-semibold text-blue-600">Var Group</span>
        </p>
        <p class="mt-2 text-xs text-gray-400 max-w-2xl mx-auto px-4">
            Alimentato dall'expertise di 60 anni, partnership certificate e soluzioni proprietarie
        </p>
    </div>

    <script>
    // API Configuration
        const API_KEY = "AIzaSyDjlVWJIzGCa5CnXbj_nQEj1aG2aHlLwnQ";
        
        // Multimedia & Workspaces Context Completo
        const MW_CONTEXT = `
# Var Group - Multimedia & Workspaces Business Unit

## Identità e Struttura Corporate
**Durante + Sangalli Tecnologie** formano la BU Multimedia & Workspaces di **Var Group**, società controllata al 100% dal **Gruppo SeSa** (fatturato 3.210 milioni di euro), leader in Italia nella distribuzione di soluzioni IT a valore per le imprese, quotata dal 2013 sul Mercato Telematico Azionario di Borsa Italiana.

### Numeri Chiave della BU (al 30.04.2024)
- **Fatturato**: 823 milioni di euro
- **EBITDA**: 99,4 milioni di euro  
- **Persone**: 3.850 collaboratori
- **Esperienza**: 51 anni di competenza nel settore
- **Copertura**: Italia + presenza internazionale (Europa, Messico, Brasile)

## Mission
La BU Multimedia & Workspaces si occupa di far comunicare e collaborare al meglio le persone in ogni luogo e contesto. Con oltre 60 anni di esperienza, progettiamo e integriamo spazi di lavoro ibridi e soluzioni di comunicazione, agendo come partner unico per l'intero ciclo di vita del progetto.

## Pilastri degli Hybrid Workspaces
1. **User Experience**: Massima semplicità d'uso, performance elevate ed ergonomia
2. **Technologies**: Best Collaboration, Best Audio Visual, Hybrid Work Platform
3. **ESG**: Benessere delle persone, sostenibilità ambientale ed economica

## Aree di Competenza Principali

### Microsoft Modern Work
**Microsoft Solutions Partner Modern Work & Security**
- **Adoption Plan**: BECOME MODERN → MAKE EVERYTHING SECURE → MANAGE YOUR DEVICE → UNLOCK THE POWER OF PERSONAL AI
- Suite Microsoft 365 completa: Exchange, Outlook, Teams, OneDrive, SharePoint
- Cloud Security: EntraID, Defender, Sentinel
- Device Management: Intune
- Data Governance: Purview
- AI personale con **Microsoft Copilot**

### Collaboration Solutions
**"Permettere alle persone di lavorare e collaborare efficacemente da ogni luogo e in ogni contesto"**
- **Enterprise Telephony**
- **Videoconference Solutions** 
- **Hybrid Collaboration**
- Partner certificati: Microsoft, Cisco Gold Integrator, Pexip Gold Partner, Poly Platinum Partner, Logitech One Tier Partner, Zoom, Google Cloud, Neat

### Allestimenti Workplace
**Da oltre 30 anni** progettiamo e integriamo spazi di lavoro pensati per enfatizzare la user experience attraverso design integrato tra architettura e tecnologia, qualità audio-video eccellenti e massima semplicità d'uso anche in modalità BYOD.
- **Huddle Room**: piccoli spazi di lavoro estremamente efficienti
- **Meeting Room**: sale riunioni multimediali, intuitive ed efficaci  
- **Board Room**: spazi di pregio pensati per le esigenze dei CDA
- **Training Room**: sale pensate per facilitare la formazione
- **Demo Room**: spazi disegnati per enfatizzare le emozioni

### Spazi Specializzati

#### Media Room
Spazio pensato per realizzare webinar, podcast, live social o creare contenuti:
- Tecnologie green screen avanzate
- Acustica attiva e passiva di qualità Hi-Fi
- Set multicamera e sistema di regia live  
- Illuminazione naturale e artificiale
- Attrezzature professionali
- Modularità e versatilità

#### Control Room  
Sviluppiamo progetti di alta complessità per control room e situation room:
- Design multimediale
- Design di rete e alimentazioni
- Security design
- Integrazione dispositivi e software
- Sistemi pluri ridondati
- Disaster recovery system

#### Digital Reception - Agrid Welcome (AW)
Digital reception basata su **Microsoft Teams** che consente di remotizzare il processo di accoglienza:
- Collegamento video ospite-receptionist
- Acquisizione e stampa documenti da remoto
- Attivazione dispositivi e varchi da casa
- Più varchi, nessuna risorsa full dedicata
- Qualità audiovisiva eccellente

#### Remote Expert - Agrid Bank
Soluzione di remote expert per filiali bancarie che consente videoconferenza per consulenza e vendita:
- Collegamento più filiali a risorse specializzate remote
- Scelta del miglior consulente per soluzioni finanziarie
- Gestione code di attesa clienti
- Gestione remota scansione, firma e stampa contratti
- Sistemi cash-in/cash-out
- Funzioni Remote Teller

### Hybrid Work Platform - Spacebooking
Piattaforma proprietaria con user experience semplice per organizzare lavoro in sede e remoto:
- **Prenota** desk, sale, individua colleghi (indoor maps)
- **Programma** hybrid working
- **Organizza** lavoro in team
- **Ottimizza** prenotazioni in chiave green
- **Governa** flussi di hybrid working
- **Integrazione** multi-touchpoint: WEB, App, Teams, Outlook, Google Workspace, assistenti vocali

### Digital Signage e Audio-Video
Soluzioni end-to-end per comunicazione visiva con **numeri consolidati**:
- **AUTOMOTIVE**: 580 store worldwide
- **GDO**: 260 store in Italy  
- **RETAIL**: 1.200 shops in Europe
- **ENTERTAINMENT**: 64 venues in Italy

**Servizi completi**: Progettazione → SW/HW selection → Installazione → Contenuti → Manage & Optimize
- Assistenza cloud, Move/Add/Change 24h, Online/On-site

### Progetti Audio-Video Specializzati
- **Musei**: Installazioni multimediali immersive
- **Teatri**: Sistemi audio-video professionali con tecnologie avanzate
- **Arene e Stadi**: Impianti per grandi eventi e spettacoli
- **Real Estate, Hospitality, Yacht**: Soluzioni su misura per settori luxury

### Hybrid Events
Organizziamo eventi creativi, interattivi e sostenibili:
- **Tipologie**: Keynote, Presentazioni prodotto, Sfilate, Webinar, Streaming, Broadcasting, Convention, CDA, Townhall
- **Modalità**: In presenza, Virtuali, Hybrid, LIVE o registrati
- **Servizi pre-event**: concept, organizzazione, noleggio, installazione, creazione contenuti
- **Servizi LIVE**: regia, coordinamento multi-site, collegamenti videoconferenza, streaming, recording

## Processo di Vendita Tipico - Metodologia Consolidata
1. **Call di Qualifica**: Analisi esigenze cliente con HR/IT Manager
2. **Sopralluogo e Raccolta Dati**: Planimetrie, foto, misure, requisiti specifici  
3. **Brief al DSA**: Trasferimento informazioni al reparto Design & Solution Architecture
4. **Progettazione**: DSA crea soluzione tecnica con Tech Annex ed Economics
5. **Presentazione Offerta**: Presentazione soluzione completa al cliente

## Target Clienti Principali
- **HR Manager**: Responsabili gestione spazi e benessere dipendenti
- **IT Manager**: Responsabili infrastruttura tecnologica e sicurezza  
- **Facility Manager**: Gestione immobili e spazi aziendali
- **C-Level**: Decision maker per investimenti strategici

## Soluzioni Tecnologiche Standard
- **BYOD (Bring Your Own Device)**: Connessione dispositivi personali
- **MTR (Microsoft Teams Rooms)**: Sale certificate Microsoft Teams
- **Soluzioni Ibride**: Combinazione BYOD + MTR per massima flessibilità
- **Audio**: Sistemi di amplificazione, diffusione e acquisizione
- **Video**: Telecamere, proiettori, monitor, sistemi di switching  
- **Controllo**: Pannelli touch, automazione, gestione centralizzata

## Certificazioni e Partnership Complete

### Certificazioni Qualità
- **UNI 11799:2020**: Servizi di integrazione dei sistemi Audio Video e Controllo (AVC)
- **ISO 9001:15**: Sistema gestione qualità

### Partnership Strategiche (livelli certificati)
- **Microsoft**: Modern Work Solutions Partner & Security Solutions Partner
- **Cisco**: Gold Integrator  
- **Poly/HP**: Platinum Partner
- **Logitech**: One Tier Partner
- **Avaya**: Emerald Partner
- **Pexip**: Gold Partner
- **Telenia**: Premier Integrator
- **Zoom**: Official Partner
- **Epson, LG, Samsung, Sharp/NEC**: Official Partner
- **Creston, Extron, Barco, Kramer**: Official Partner

## DOC (Durante Operation Center) - Manage & Optimize
Supporto tecnico di altissima qualità con **tecnici certificati da oltre 35 anni**:
- **Help Desk multi-livello**: competenze dal primo step (HD1) fino ai sistemisti senior (HD3)
- **VNOC (Video Network Operation Center)**: il concierge per la videoconferenza
- **Monitoraggio proattivo**: cloud, on-prem e gestione di guasti e allarmi
- **Servizio 24x365**: presidi on-site e supporto continuo

## Copertura Territoriale
- **Italia**: Rete capillare di sedi in tutte le principali città (Milano, Roma, Torino, Genova, Bologna, Firenze, Napoli, Bari, Catania, Cagliari, etc.)
- **Internazionale**: Presenza consolidata in Europa, Messico, Brasile
- **Prossimità territoriale = prossimità culturale**: approccio locale con standard globali
        `;

        // Hardware Database
        const HARDWARE_DB = {
            yealink: {
                A40: { name: "Yealink A40", type: "Small/Huddle", modes: ["BYOD", "MTR", "ZOOM"], capacity: "1-6 persone", maxPickup: "3m" },
                A50: { name: "Yealink A50", type: "Medium", modes: ["BYOD", "MTR", "ZOOM"], capacity: "6-12 persone", maxPickup: "5m" },
                MeetingBoard: { name: "Yealink MeetingBoard", type: "Small/Huddle", modes: ["BYOD", "MTR", "ZOOM"], capacity: "1-6 persone", maxPickup: "3m" },
                VMC36W: { name: "Yealink VMC36-W Package", type: "Additional Microphone", modes: ["Wireless"], capacity: "Expansion", maxPickup: "2m" },
                PA20: { name: "Yealink PA20", type: "Wireless Sharing", modes: ["BYOD"], capacity: "Content Sharing", maxPickup: "N/A" }
            },
            logitech: {
                Meetup2: { name: "Logitech Meetup 2", type: "Huddle/Small", modes: ["BYOD", "MTR", "ZOOM", "GOOGLE MEET"], capacity: "1-6 persone", maxPickup: "2.4m" },
                RallyBarHuddle: { name: "Logitech Rally Bar Huddle", type: "Huddle/Small", modes: ["BYOD", "MTR", "ZOOM", "GOOGLE MEET"], capacity: "1-6 persone", maxPickup: "3m" },
                RallyBar: { name: "Logitech Rally Bar", type: "Medium/Large", modes: ["BYOD", "MTR", "ZOOM", "GOOGLE MEET"], capacity: "6-16 persone", maxPickup: "5.5m" },
                RallyPlus: { name: "Logitech Rally Plus", type: "Large", modes: ["BYOD", "MTR", "ZOOM", "GOOGLE MEET"], capacity: "12+ persone", maxPickup: "7m" },
                MicExpansion: { name: "Logitech Microfono Espansione", type: "Additional Microphone", modes: ["Wired"], capacity: "Expansion", maxPickup: "2.2m" }
            },
            poly: {
                X32: { name: "Poly X32", type: "Small", modes: ["BYOD", "MTR", "ZOOM", "GOOGLE MEET"], capacity: "3-6 persone", maxPickup: "3.5m" },
                X52: { name: "Poly X52", type: "Medium/Large", modes: ["BYOD", "MTR", "ZOOM", "GOOGLE MEET"], capacity: "6-12 persone", maxPickup: "5m" },
                X72: { name: "Poly X72", type: "Medium/Large", modes: ["BYOD", "MTR", "ZOOM", "GOOGLE MEET"], capacity: "6-16 persone", maxPickup: "6m" },
                SYNC: { name: "Poly SYNC", type: "Additional Microphone", modes: ["Wireless"], capacity: "Expansion", maxPickup: "2m" }
            },
            cisco: {
                RoomBar: { name: "Cisco Room Bar", type: "Small/Huddle", modes: ["BYOD", "MTR", "ZOOM", "GOOGLE MEET"], capacity: "1-5 persone", maxPickup: "3m" },
                RoomBarPro: { name: "Cisco Room Bar Pro", type: "Medium/Large", modes: ["BYOD", "MTR", "ZOOM", "GOOGLE MEET"], capacity: "6-16 persone", maxPickup: "5m" },
                TableMicrophonePro: { name: "Cisco Table Microphone Pro", type: "Additional Microphone", modes: ["Wired"], capacity: "Expansion", maxPickup: "3.5m" },
                CeilingMicrophonePro: { name: "Cisco Ceiling Microphone Pro", type: "Additional Microphone", modes: ["PoE"], capacity: "Expansion", maxPickup: "4m" }
            },
            barco: {
                ClickShareBarPro: { name: "Barco ClickShare Bar Pro", type: "Medium", modes: ["BYOD"], capacity: "6-12 persone", maxPickup: "4m" },
                ClickShareBarCore: { name: "Barco ClickShare Bar Core", type: "Small/Huddle", modes: ["BYOD"], capacity: "1-6 persone", maxPickup: "3m" },
                CX20_1: { name: "Barco ClickShare CX-20 (1 bottone)", type: "Wireless Sharing", modes: ["BYOD"], capacity: "Content Sharing", maxPickup: "N/A" },
                CX20_2: { name: "Barco ClickShare CX-20 (2 bottoni)", type: "Wireless Sharing", modes: ["BYOD"], capacity: "Content Sharing", maxPickup: "N/A" },
                CX50: { name: "Barco ClickShare CX-50 (2 bottoni)", type: "Wireless Sharing", modes: ["BYOD"], capacity: "Content Sharing", maxPickup: "N/A" }
            }
        };

// State management
        let uploadedFiles = [];
        let transcriptContent = '';
        let generatedBriefContent = '';
        let spaceFiles = [];
        let selectedInputMethod = '';
        let roomData = {};
        let analysisFile = null;
        let extractedData = {};
        let generatedFileData = null;

        // Navigation functions
        function showIntro() {
            document.getElementById('introSection').classList.remove('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.add('hidden');
        }
        
        function showPostMeeting() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.remove('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        function showSpaceWizard() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.remove('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        function showFileGenerator() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.remove('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
            resetFileGenerator();
        }

         // Room Classification
        function classifyRoom(capacity, sqm) {
            if (capacity <= 3 && sqm < 10) return "HUDDLE";
            if (capacity <= 6 && sqm <= 18) return "SMALL";
            if (capacity <= 12 && sqm <= 30) return "MEDIUM";
            return "LARGE";
        }
        
         // Wizard Functions
        function selectInputMethod(method) {
            selectedInputMethod = method;
            document.getElementById('radioManual').checked = method === 'manual';
            document.getElementById('radioUpload').checked = method === 'upload';
            
            if (method === 'manual') {
                document.getElementById('manualFields').classList.remove('hidden');
                document.getElementById('uploadFields').classList.add('hidden');
                document.getElementById('manualInput').parentElement.classList.add('border-cyan-500', 'bg-cyan-50');
                document.getElementById('uploadInput').parentElement.classList.remove('border-cyan-500', 'bg-cyan-50');
            } else {
                document.getElementById('manualFields').classList.add('hidden');
                document.getElementById('uploadFields').classList.remove('hidden');
                document.getElementById('uploadInput').parentElement.classList.add('border-cyan-500', 'bg-cyan-50');
                document.getElementById('manualInput').parentElement.classList.remove('border-cyan-500', 'bg-cyan-50');
            }
        }
        
        // File Upload Handlers for Wizard
        async function handleSpaceFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const fileObj = { name: file.name, type: type, file: file };
            spaceFiles.push(fileObj);

            updateSpaceFileDisplay();

            // Analyze with Gemini Vision
            if (type === 'photo' && (file.name.toLowerCase().endsWith('.jpg') || file.name.toLowerCase().endsWith('.jpeg') || file.name.toLowerCase().endsWith('.tiff'))) {
                await analyzeImageWithAI(file);
            } else if (type === 'plan') {
                await analyzePlanWithAI(file);
            }
        }

        function updateSpaceFileDisplay() {
            const container = document.getElementById('uploadedSpaceFiles');
            const fileList = document.getElementById('spaceFileList');
            
            if (spaceFiles.length > 0) {
                container.classList.remove('hidden');
                fileList.innerHTML = spaceFiles.map((file, index) => `
                    <div class="flex items-center justify-between bg-cyan-100 p-3 rounded-lg">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-cyan-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${file.type === 'photo' ? 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z' : 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z'}"></path>
                            </svg>
                            <span class="font-medium text-cyan-800">${file.name}</span>
                            <span class="text-xs text-cyan-600 ml-2">(${file.type === 'photo' ? 'Foto' : 'Planimetria'})</span>
                        </div>
                        <button onclick="removeSpaceFile(${index})" class="text-red-500 hover:text-red-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `).join('');
            } else {
                container.classList.add('hidden');
            }
        }

        function removeSpaceFile(index) {
            spaceFiles.splice(index, 1);
            updateSpaceFileDisplay();
            if (spaceFiles.length === 0) {
                document.getElementById('aiAnalysisResult').classList.add('hidden');
            }
        }

        async function analyzeImageWithAI(file) {
            try {
                // Convert image to base64
                const base64 = await fileToBase64(file);
                
                const prompt = `Agisci come un esperto in spazi collaborativi e analizza questa immagine di una sala riunioni/spazio di lavoro.

Estrai e fornisci le seguenti informazioni in formato strutturato:

1. DIMENSIONI STIMATE:
- Metri quadri approssimativi
- Larghezza stimata (metri)  
- Lunghezza stimata (metri)
- Altezza stimata (metri)

2. CAPACITÀ:
- Numero persone che può ospitare comodamente

3. CARATTERISTICHE SPAZIO:
- Tipologia spazio (Huddle/Small/Medium/Large Room)
- Presenza di tavolo/i (forma, dimensioni)
- Configurazione sedute
- Pareti (vetro, muro, miste)
- Illuminazione (naturale/artificiale)
- Presenza monitor/display esistenti

4. CONSIDERAZIONI TECNICHE:
- Sfide acustiche potenziali
- Posizionamento ottimale telecamera
- Necessità cablaggio particolare
- Altri elementi rilevanti per installazione AV

Rispondi in formato JSON strutturato per facilitare l'elaborazione automatica.`;

                const response = await callGeminiVision(prompt, base64);
                displayAIAnalysis(response, 'photo');
                
            } catch (error) {
                console.error('Errore analisi immagine:', error);
                alert('Errore nell\'analisi dell\'immagine. Utilizzare inserimento manuale.');
            }
        }

        async function analyzePlanWithAI(file) {
            try {
                let content = '';
                
                if (file.name.toLowerCase().endsWith('.pdf')) {
                    content = await readFileAsText(file);
                } else {
                    // For DWG files, we'll analyze as image
                    const base64 = await fileToBase64(file);
                    const prompt = `Analizza questa planimetria e estrai:
1. Dimensioni della sala (lunghezza x larghezza in metri)
2. Area in metri quadri
3. Altezza se indicata
4. Capacità persone stimata in base alle dimensioni
5. Note particolari (porte, finestre, ostacoli)

Fornisci risposta in formato JSON strutturato.`;
                    
                    const response = await callGeminiVision(prompt, base64);
                    displayAIAnalysis(response, 'plan');
                    return;
                }
                
                displayAIAnalysis(`Planimetria ${file.name} caricata. Analisi dimensioni da sviluppare per file ${file.name.split('.').pop().toUpperCase()}.`, 'plan');
                
            } catch (error) {
                console.error('Errore analisi planimetria:', error);
                alert('Errore nell\'analisi della planimetria. Utilizzare inserimento manuale.');
            }
        }

        function displayAIAnalysis(response, type) {
            const resultDiv = document.getElementById('aiAnalysisResult');
            const contentDiv = document.getElementById('aiAnalysisContent');
            
            resultDiv.classList.remove('hidden');
            
            try {
                // Clean the response to extract JSON
                let jsonString = response;
                
                // Try to find JSON in the response
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    jsonString = jsonMatch[0];
                }
                
                // Parse JSON response
                const parsed = JSON.parse(jsonString);
                
                let analysisHTML = `<strong>Analisi ${type === 'photo' ? 'Foto' : 'Planimetria'}:</strong><br>`;
                
                // Display analysis results
                if (parsed.DIMENSIONI_STIMATE) {
                    const dim = parsed.DIMENSIONI_STIMATE;
                    analysisHTML += `<strong>Dimensioni:</strong> ${dim.Metri_quadri_approssimativi || 'N/A'} mq, ${dim.Larghezza_stimata_metri || 'N/A'}m x ${dim.Lunghezza_stimata_metri || 'N/A'}m x ${dim.Altezza_stimata_metri || 'N/A'}m<br>`;
                    
                    // Auto-fill form fields
                    if (dim.Metri_quadri_approssimativi) {
                        const sqmField = selectedInputMethod === 'upload' ? 'roomSqmAI' : 'roomSqm';
                        document.getElementById(sqmField).value = dim.Metri_quadri_approssimativi;
                    }
                    if (dim.Larghezza_stimata_metri) {
                        const widthField = selectedInputMethod === 'upload' ? 'roomWidthAI' : 'roomWidth';
                        document.getElementById(widthField).value = dim.Larghezza_stimata_metri;
                    }
                    if (dim.Lunghezza_stimata_metri) {
                        const lengthField = selectedInputMethod === 'upload' ? 'roomLengthAI' : 'roomLength';
                        document.getElementById(lengthField).value = dim.Lunghezza_stimata_metri;
                    }
                    if (dim.Altezza_stimata_metri) {
                        const heightField = selectedInputMethod === 'upload' ? 'roomHeightAI' : 'roomHeight';
                        document.getElementById(heightField).value = dim.Altezza_stimata_metri;
                    }
                }
                
                if (parsed.CAPACITA && parsed.CAPACITA.Numero_persone) {
                    analysisHTML += `<strong>Capacità:</strong> ${parsed.CAPACITA.Numero_persone} persone<br>`;
                    
                    const capacityField = selectedInputMethod === 'upload' ? 'roomCapacityAI' : 'roomCapacity';
                    document.getElementById(capacityField).value = parsed.CAPACITA.Numero_persone;
                }
                
                if (parsed.CARATTERISTICHE_SPAZIO && parsed.CARATTERISTICHE_SPAZIO.Tipologia_spazio) {
                    analysisHTML += `<strong>Tipologia:</strong> ${parsed.CARATTERISTICHE_SPAZIO.Tipologia_spazio}<br>`;
                }
                
                contentDiv.innerHTML = analysisHTML;
                
            } catch (e) {
                console.error('Errore nel parsing JSON:', e);
                console.log('Risposta originale:', response);
                
                // If JSON parsing fails, try to extract data manually from the text
                const numbers = response.match(/\d+(?:\.\d+)?/g);
                if (numbers && numbers.length >= 4) {
                    // Try to extract: mq, larghezza, lunghezza, altezza, capacità
                    const sqmField = selectedInputMethod === 'upload' ? 'roomSqmAI' : 'roomSqm';
                    const widthField = selectedInputMethod === 'upload' ? 'roomWidthAI' : 'roomWidth';
                    const lengthField = selectedInputMethod === 'upload' ? 'roomLengthAI' : 'roomLength';
                    const heightField = selectedInputMethod === 'upload' ? 'roomHeightAI' : 'roomHeight';
                    const capacityField = selectedInputMethod === 'upload' ? 'roomCapacityAI' : 'roomCapacity';
                    
                    // Extract values based on position in the response
                    if (numbers[0]) document.getElementById(sqmField).value = numbers[0];
                    if (numbers[1]) document.getElementById(widthField).value = numbers[1];
                    if (numbers[2]) document.getElementById(lengthField).value = numbers[2];
                    if (numbers[3]) document.getElementById(heightField).value = numbers[3];
                    if (numbers.length > 4 && numbers[4]) document.getElementById(capacityField).value = numbers[4];
                }
                
                // Display as text
                contentDiv.innerHTML = `<strong>Analisi completata:</strong><br>${response.substring(0, 500)}...`;
            }
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        // Call Gemini Vision API
        async function callGeminiVision(prompt, base64Image) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                        ]
                    }]
                })
            });

            const result = await response.json();
            if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            }
            throw new Error("Risposta AI non valida");
        }

        // Generate Space Proposal
        async function generateSpaceProposal() {
            // Validate inputs
            if (!selectedInputMethod) {
                alert('Seleziona un metodo di input (Manuale o Upload)');
                return;
            }

            const clientName = document.getElementById('wizardClientName').value.trim();
            const spaceName = document.getElementById('wizardSpaceName').value.trim();
            const vcMode = document.querySelector('input[name="vcMode"]:checked')?.value;

            if (!clientName || !spaceName || !vcMode) {
                alert('Compila tutti i campi obbligatori');
                return;
            }

            let capacity, sqm, width, length, height, notes;

            if (selectedInputMethod === 'manual') {
                capacity = parseInt(document.getElementById('roomCapacity').value) || 0;
                sqm = parseFloat(document.getElementById('roomSqm').value) || 0;
                width = parseFloat(document.getElementById('roomWidth').value) || 0;
                length = parseFloat(document.getElementById('roomLength').value) || 0;
                height = parseFloat(document.getElementById('roomHeight').value) || 2.7;
                notes = document.getElementById('roomNotes').value.trim();

                if (!capacity) {
                    alert('Inserisci almeno la capacità persone');
                    return;
                }

                // Calculate missing dimensions
                if (!sqm && width && length) sqm = width * length;
                if (!width && !length && sqm) {
                    width = Math.sqrt(sqm);
                    length = width;
                }
            } else {
                // Get from AI analysis or require manual input
                capacity = parseInt(document.getElementById('roomCapacityAI').value) || 0;
                sqm = parseFloat(document.getElementById('roomSqmAI').value) || 0;
                width = parseFloat(document.getElementById('roomWidthAI').value) || 0;
                length = parseFloat(document.getElementById('roomLengthAI').value) || 0;
                height = parseFloat(document.getElementById('roomHeightAI').value) || 2.7;

                if (!capacity || !sqm) {
                    alert('L\'analisi AI non ha fornito dati sufficienti. Compila manualmente capacità e dimensioni.');
                    return;
                }
            }

            roomData = { clientName, spaceName, capacity, sqm, width, length, height, notes, vcMode };

            // Show loading
            const btn = document.getElementById('wizardGenerateBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `
                <svg class="w-5 h-5 mr-3 loading" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Generazione in corso...
            `;
            btn.disabled = true;

            try {
                const proposal = await generateConfigurationProposal();
                
                document.getElementById('proposalContent').innerHTML = proposal;
                document.getElementById('wizardForm').classList.add('hidden');
                document.getElementById('generatedProposal').classList.remove('hidden');
                document.getElementById('generatedProposal').classList.add('fade-in');

            } catch (error) {
                alert('Errore nella generazione della proposta: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function generateConfigurationProposal() {
            const roomType = classifyRoom(roomData.capacity, roomData.sqm);
            
            const prompt = `Agisci come un Senior Solution Architect di Var Group - Multimedia & Workspaces specializzato in configurazioni spazi collaborativi.

DATI SPAZIO:
- Cliente: ${roomData.clientName}
- Nome Spazio: ${roomData.spaceName}
- Capacità: ${roomData.capacity} persone
- Dimensioni: ${roomData.sqm} mq (${roomData.width}m x ${roomData.length}m x ${roomData.height}m)
- Tipologia: ${roomType} ROOM
- Modalità VC: ${roomData.vcMode}
- Note: ${roomData.notes || 'Nessuna'}

CONTESTO AZIENDALE:
${MW_CONTEXT}

DATABASE HARDWARE DISPONIBILE:
${JSON.stringify(HARDWARE_DB, null, 2)}

CRITERI DIMENSIONALI:
- HUDDLE ROOM: 1-3 persone, < 10 mq
- SMALL ROOM: 3-6 persone, 10-18 mq  
- MEDIUM ROOM: 6-12 persone, 18-30 mq
- LARGE ROOM: >12 persone, >30 mq

TASK: Genera un'offerta express professionale in formato HTML che includa:

1. **EXECUTIVE SUMMARY**
   - Inquadramento del progetto
   - Tipologia spazio identificata
   - Soluzione tecnologica raccomandata

2. **CONFIGURAZIONE PROPOSTA**
   - Barra all-in-one principale (con giustificazione scelta)
   - Monitor (se necessario)
   - Microfoni aggiuntivi (basato su analisi pick-up vs dimensioni sala)
   - Sistema condivisione contenuti
   - Accessori e cablaggio

3. **TABELLA COMPONENTI** (formato simile template JBT allegato)
   - Quantità, Descrizione dettagliata, Prezzo unitario placeholder
   - Sezione servizi professionali
   - Totale configurazione

4. **BENEFICI SOLUZIONE**
   - Vantaggi specifici per la tipologia di spazio
   - Benefici della modalità ${roomData.vcMode} scelta
   - User Experience e produttività

5. **SPECIFICHE TECNICHE**
   - Compatibilità piattaforme
   - Range microfoni e copertura acustica
   - Qualità video e audio garantita

IMPORTANTE:
- Utilizza SOLO hardware dal database fornito
- Considera compatibilità ${roomData.vcMode} per ogni componente
- Analizza se servono microfoni aggiuntivi basandoti sul range pick-up della barra vs dimensioni sala
- Includi almeno 1 alternativa di configurazione se appropriato
- Prezzi placeholder (€ TBD) in attesa di listini

Genera offerta in HTML professionale, completa e pronta per il cliente.`;

            return await callGeminiAPI(prompt);
        }

        function downloadProposalWord() {
            // This would generate a Word document - placeholder for now
            alert('Funzionalità download Word in sviluppo. Per ora utilizza copia/incolla del contenuto.');
        }

        function resetWizard() {
            // Reset all wizard fields
            document.getElementById('wizardClientName').value = '';
            document.getElementById('wizardSpaceName').value = '';
            document.getElementById('wizardBudget').value = '';
            document.getElementById('roomSqm').value = '';
            document.getElementById('roomWidth').value = '';
            document.getElementById('roomLength').value = '';
            document.getElementById('roomHeight').value = '';
            document.getElementById('roomCapacity').value = '';
            document.getElementById('roomNotes').value = '';
            
            // Reset AI fields
            document.getElementById('roomSqmAI').value = '';
            document.getElementById('roomWidthAI').value = '';
            document.getElementById('roomLengthAI').value = '';
            document.getElementById('roomHeightAI').value = '2.7';
            document.getElementById('roomCapacityAI').value = '';
            
            // Reset radio buttons and checkboxes
            document.querySelectorAll('input[name="vcMode"]').forEach(r => r.checked = false);
            document.querySelectorAll('input[name="inputMethod"]').forEach(r => r.checked = false);
            document.getElementById('hasExistingMonitor').checked = false;
            document.getElementById('needsWirelessSharing').checked = false;
            document.getElementById('acousticChallenges').checked = false;
            
            // Reset file uploads
            spaceFiles = [];
            updateSpaceFileDisplay();
            document.getElementById('photoUpload').value = '';
            document.getElementById('planUpload').value = '';
            
            // Reset UI state
            selectedInputMethod = '';
            document.getElementById('manualFields').classList.add('hidden');
            document.getElementById('uploadFields').classList.add('hidden');
            document.getElementById('aiAnalysisResult').classList.add('hidden');
            document.getElementById('manualInput').parentElement.classList.remove('border-cyan-500', 'bg-cyan-50');
            document.getElementById('uploadInput').parentElement.classList.remove('border-cyan-500', 'bg-cyan-50');
            
            // Show form, hide proposal
            document.getElementById('wizardForm').classList.remove('hidden');
            document.getElementById('generatedProposal').classList.add('hidden');
            
            roomData = {};
        }

        // File upload handling for planimetrie/documenti (POST MEETING MODULE)
        document.getElementById('fileUpload').addEventListener('change', function(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                const fileObj = {
                    name: file.name,
                    size: (file.size / 1024 / 1024).toFixed(2) + ' MB',
                    type: file.type || 'application/octet-stream'
                };
                uploadedFiles.push(fileObj);
            });

            updateFileDisplay();
        });

        // Enhanced transcript upload handling with better DOCX support
        document.getElementById('transcriptUpload').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                let content = '';
                
                // Handle different file types
                if (file.name.toLowerCase().endsWith('.docx')) {
                    // Use mammoth.js for DOCX files
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                    content = result.value;
                } else if (file.name.toLowerCase().endsWith('.pdf')) {
                    // For PDF files, read as text (basic extraction)
                    content = await readFileAsText(file);
                    content = "File PDF caricato: " + file.name + "\n\nNOTA: Per i file PDF è consigliabile copiare manualmente il testo nelle note del meeting per una migliore analisi.";
                } else {
                    // For TXT and other text files
                    content = await readFileAsText(file);
                }

                // Clean up transcript content for Teams format
                content = cleanTeamsTranscript(content);
                transcriptContent = content;
                
                // Show file info
                document.getElementById('transcriptFileName').textContent = file.name;
                document.getElementById('transcriptFile').classList.remove('hidden');
                
                // Show preview
                const preview = content.substring(0, 500) + (content.length > 500 ? '...' : '');
                document.getElementById('transcriptPreviewContent').textContent = preview;
                document.getElementById('transcriptPreview').classList.remove('hidden');
                
                // Add content to meeting notes
                const meetingNotesTextarea = document.getElementById('meetingNotes');
                const currentNotes = meetingNotesTextarea.value;
                const separator = currentNotes ? '\n\n--- TRASCRIZIONE MEETING ---\n' : '--- TRASCRIZIONE MEETING ---\n';
                meetingNotesTextarea.value = currentNotes + separator + content;
                
            } catch (error) {
                console.error('Errore nel caricamento del file:', error);
                alert('Errore nel caricamento del file: ' + error.message);
            }
        });

        // Clean Teams transcript function
        function cleanTeamsTranscript(rawContent) {
            if (!rawContent) return '';
            
            let cleaned = rawContent;
            
            // Remove image references and metadata
            cleaned = cleaned.replace(/!\[.*?\]\(.*?\)/g, '');
            cleaned = cleaned.replace(/\{width=".*?"\s*height=".*?"\}/g, '');
            cleaned = cleaned.replace(/media\/[a-zA-Z0-9_-]+\.png/g, '');
            
            // Remove timestamp headers
            cleaned = cleaned.replace(/\*\*Trascrizione\*\*\s*\d+.*?\d+:\d+[AP]M/g, '');
            
            // Clean up speaker names and format
            cleaned = cleaned.replace(/\*\*\\\s*/g, '');
            cleaned = cleaned.replace(/\*\*\s*([^*]+)\*\*\s*(\d+:\d+)\\\s*/g, '\n$1 ($2): ');
            cleaned = cleaned.replace(/\*\*\s*([^*]+)\*\*\s*/g, '\n$1: ');
            
            // Remove extra asterisks and formatting
            cleaned = cleaned.replace(/\*+/g, '');
            cleaned = cleaned.replace(/\\\s*/g, ' ');
            
            // Clean up multiple newlines and spaces
            cleaned = cleaned.replace(/\n\s*\n\s*\n/g, '\n\n');
            cleaned = cleaned.replace(/[ \t]+/g, ' ');
            
            // Remove "trascrizione avviata/arrestata" lines
            cleaned = cleaned.replace(/.*trascrizione (avviata|arrestata).*/gi, '');
            
            return cleaned.trim();
        }

        // Read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                
                reader.onerror = function() {
                    reject(new Error('Errore nella lettura del file'));
                };
                
                reader.readAsText(file, 'UTF-8');
            });
        }

        // Remove transcript
        function removeTranscript() {
            transcriptContent = '';
            document.getElementById('transcriptFile').classList.add('hidden');
            document.getElementById('transcriptPreview').classList.add('hidden');
            document.getElementById('transcriptUpload').value = '';
            
            // Remove from meeting notes
            const meetingNotesTextarea = document.getElementById('meetingNotes');
            const content = meetingNotesTextarea.value;
            const cleanedContent = content.replace(/\n*--- TRASCRIZIONE MEETING ---\n[\s\S]*$/, '');
            meetingNotesTextarea.value = cleanedContent;
        }

        function updateFileDisplay() {
            const uploadedFilesDiv = document.getElementById('uploadedFiles');
            const fileList = document.getElementById('fileList');
            
            if (uploadedFiles.length > 0) {
                uploadedFilesDiv.classList.remove('hidden');
                fileList.innerHTML = uploadedFiles.map((file, index) => `
                    <div class="flex items-center justify-between bg-gray-100 p-3 rounded-lg">
                        <div>
                            <span class="font-medium">${file.name}</span>
                            <span class="text-sm text-gray-500 ml-2">(${file.size})</span>
                        </div>
                        <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `).join('');
            } else {
                uploadedFilesDiv.classList.add('hidden');
            }
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileDisplay();
        }

        // Form validation
        function canGenerateBrief() {
            const clientName = document.getElementById('clientName').value.trim();
            const meetingNotes = document.getElementById('meetingNotes').value.trim();
            const numberOfRooms = document.getElementById('numberOfRooms').value.trim();
            
            return clientName && meetingNotes && numberOfRooms;
        }

        // Get selected values from checkboxes
        function getSelectedValues(containerId) {
            const container = document.getElementById(containerId);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Generate brief using Gemini AI
        async function generateBrief() {
            if (!canGenerateBrief()) {
                alert('Per favore compila almeno: Nome Cliente, Numero Sale/Spazi e Note del Meeting');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            const originalText = generateBtn.innerHTML;
            
            // Show loading state
            generateBtn.innerHTML = `
                <svg class="w-5 h-5 mr-3 loading" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Generazione in corso...
            `;
            generateBtn.disabled = true;

            try {
                // Collect form data
                const formData = {
                    clientName: document.getElementById('clientName').value,
                    contactPerson: document.getElementById('contactPerson').value,
                    meetingDate: document.getElementById('meetingDate').value,
                    numberOfRooms: document.getElementById('numberOfRooms').value,
                    budget: document.getElementById('budget').value,
                    spaceTypes: getSelectedValues('spaceTypes'),
                    techRequirements: getSelectedValues('techRequirements'),
                    meetingNotes: document.getElementById('meetingNotes').value,
                    timeline: document.getElementById('timeline').value,
                    specialRequirements: document.getElementById('specialRequirements').value
                };

                const prompt = `Agisci come un Senior Technical Consultant di Var Group - Multimedia & Workspaces con la massima competenza tecnica e commerciale della BU.

CONTESTO AZIENDALE COMPLETO:
${MW_CONTEXT}

DATI DEL MEETING E REQUISITI CLIENTE:
- Cliente: ${formData.clientName}
- Contatto: ${formData.contactPerson}
- Data Meeting: ${formData.meetingDate}
- Numero Sale/Spazi: ${formData.numberOfRooms}
- Tipologie Spazi: ${formData.spaceTypes.join(', ')}
- Requisiti Tecnologici: ${formData.techRequirements.join(', ')}
- Budget Indicativo: ${formData.budget}
- Timeline: ${formData.timeline}
- Note del Meeting: ${formData.meetingNotes}
- Requisiti Speciali: ${formData.specialRequirements}
- File Allegati: ${uploadedFiles.map(f => f.name).join(', ')}

TASK: Genera un brief professionale e dettagliato per il team DSA (Design & Solution Architecture) che sfrutti completamente l'expertise della BU e contenga:

1. **EXECUTIVE SUMMARY**
   - Inquadramento strategico del progetto
   - Obiettivi business del cliente
   - Valore aggiunto della soluzione Var Group

2. **ANALISI REQUISITI APPROFONDITA**
   - Requisiti funzionali estratti dal meeting
   - Requisiti tecnici identificati con tecnologie specifiche
   - Vincoli architetturali, normativi e di sicurezza
   - Criticità emerse e rischi progettuali

3. **SPECIFICHE SPAZI DETTAGLIATE**
   - Dettaglio per ogni tipologia di spazio con:
     * Dimensioni e capacità suggerite
     * Funzionalità specifiche richieste
     * Tecnologie raccomandate (BYOD/MTR/Hybrid)
     * Standard di qualità audio-video
     * Integrazione con sistemi esistenti

4. **RACCOMANDAZIONI TECNOLOGICHE SPECIALIZZATE**
   - Soluzioni da portfolio Var Group (Spacebooking, Agrid Welcome, etc.)
   - Partner tecnologici specifici da coinvolgere
   - Architettura di sistema proposta
   - Certificazioni richieste (UNI 11799:2020)
   - Integrazioni Microsoft 365/Teams

5. **DELIVERABLE RICHIESTI AL DSA**
   - Tech Annex dettagliato con specifiche tecniche
   - Economics strutturato con:
     * CAPEX (hardware, software, installazione)
     * OPEX (licenze, manutenzione DOC)
     * ROI e TCO analysis
   - Timeline di implementazione con milestone
   - Documentazione tecnica e certificazioni

6. **DOCUMENTAZIONE ALLEGATA E ANALISI**
   - Riferimenti specifici ai file: ${uploadedFiles.map(f => f.name).join(', ')}
   - Indicazioni operative per utilizzo planimetrie/documenti
   - Note per rilievi tecnici aggiuntivi necessari
   - Checklist per sopralluogo tecnico DSA

7. **STRATEGIA COMMERCIALE E NEXT STEPS**
   - Positioning competitivo vs alternative
   - Elementi differenzianti della proposta
   - Stakeholder chiave da coinvolgere
   - Milestone commerciali e tecnici
   - Risk mitigation strategy

8. **CONSIDERAZIONI DOC E POST-VENDITA**
   - Servizi di supporto raccomandati
   - SLA proposti per il cliente
   - Training e change management
   - Evoluzione futura della soluzione

IMPORTANTE: 
- Utilizza terminologia tecnica specifica e numeri concreti della BU
- Fai riferimento ai nostri 51 anni di esperienza e ai 823M€ di fatturato
- Includi sempre partnership certificate e competenze specialistiche
- Se presenti file allegati, utilizzali come fonte primaria per le specifiche
- Menziona capacità internazionale e presenza geografica quando rilevante

Fornisci il brief in formato HTML professionale, completo e actionable per il team DSA.`;

                const response = await callGeminiAPI(prompt);
                
                // Show generated brief
                generatedBriefContent = response;
                document.getElementById('briefContent').innerHTML = response;
                document.getElementById('postMeetingForm').classList.add('hidden');
                document.getElementById('generatedBrief').classList.remove('hidden');
                document.getElementById('generatedBrief').classList.add('fade-in');

            } catch (error) {
                alert('Errore nella generazione del brief: ' + error.message);
            } finally {
                // Restore button
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        // Call Gemini API
        async function callGeminiAPI(prompt) {
            const modelName = "gemini-2.5-pro";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${API_KEY}`;

            const requestBody = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody),
            });
            
            if (!response.ok) {
                throw new Error(`API Error (${response.status}): ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                let rawText = result.candidates[0].content.parts[0].text;
                return rawText.replace(/^\s*```(html)?\n?/, '').replace(/\n?```\s*$/, '');
            } else {
                throw new Error("Risposta AI non nel formato atteso.");
            }
        }

        // Copy brief to clipboard
        function copyBrief() {
            if (!generatedBriefContent) return;
            
            const textArea = document.createElement("textarea");
            textArea.value = generatedBriefContent.trim();
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                // Change button text temporarily
                const copyBtn = event.target.closest('button');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = `
                    <svg class="w-4 h-4 mr-1.5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Copiato!
                `;
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                alert('Impossibile copiare il testo.');
            }
            
            document.body.removeChild(textArea);
        }

        // Reset form
        function resetForm() {
            // Reset all form fields
            document.getElementById('clientName').value = '';
            document.getElementById('contactPerson').value = '';
            document.getElementById('meetingDate').value = '';
            document.getElementById('numberOfRooms').value = '';
            document.getElementById('budget').value = '';
            document.getElementById('meetingNotes').value = '';
            document.getElementById('timeline').value = '';
            document.getElementById('specialRequirements').value = '';
            
            // Reset checkboxes
            document.querySelectorAll('#spaceTypes input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('#techRequirements input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            // Reset file uploads
            uploadedFiles = [];
            updateFileDisplay();
            
            // Reset transcript
            transcriptContent = '';
            document.getElementById('transcriptFile').classList.add('hidden');
            document.getElementById('transcriptPreview').classList.add('hidden');
            document.getElementById('transcriptUpload').value = '';
            
            // Show form, hide brief
            document.getElementById('postMeetingForm').classList.remove('hidden');
            document.getElementById('generatedBrief').classList.add('hidden');
            
            generatedBriefContent = '';
        }

        // --- MODULE 3: FILE GENERATOR FUNCTIONS ---

        async function handleAnalysisUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    try {
        analysisFile = file;
        document.getElementById('analysisFileName').textContent = file.name;
        document.getElementById('uploadedAnalysisFile').classList.remove('hidden');
        await processExcelFile(file);
    } catch (error) {
        alert('Errore: ' + error.message);
        removeAnalysisFile();
    }
}

async function processExcelFile(file) {
    try {
        const data = await readExcelFile(file);
        extractedData = extractKeyData(data);
        document.getElementById('fileGenerateBtn').disabled = false;
    } catch (error) {
        alert('Errore: ' + error.message);
        removeAnalysisFile();
    }
}

function readExcelFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                if (!sheetName) throw new Error("Il file Excel non contiene fogli di lavoro.");
                resolve(XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1, defval: '' }));
            } catch (err) { reject(err); }
        };
        reader.onerror = () => reject(new Error('Impossibile leggere il file.'));
        reader.readAsBinaryString(file);
    });
}

function extractKeyData(sheetData) {
    const extracted = { articoli: [] };
    const colonne = { I: 8, J: 9, K: 10, T: 19, U: 20 };
    for (let i = 2; i < sheetData.length; i++) {
        const row = sheetData[i];
        if (!row) continue;
        const quantitaK = parseFloat(row[colonne.K]);
        if (!isNaN(quantitaK) && quantitaK > 0) {
            extracted.articoli.push({
                colonnaI: row[colonne.I] || '',
                colonnaJ: row[colonne.J] || '',
                colonnaK: quantitaK,
                colonnaT: parseFloat(row[colonne.T]) || 0,
                colonnaU: parseFloat(row[colonne.U]) || 0,
            });
        }
    }
    extracted.totaleU = extracted.articoli.reduce((sum, art) => sum + art.colonnaU, 0);
    return extracted;
}

function generateCommercialOffer(projectData) {
    const data = projectData.extractedData;
    const dataOdierna = new Date().toLocaleDateString('it-IT');
    return `<div style="font-family:Arial,sans-serif;margin:1rem;"><h2 style="color:#1e3a8a;font-size:1.5rem;font-weight:bold;">Offerta Commerciale</h2><p><strong>Cliente:</strong> ${projectData.cliente||'N/D'}<br><strong>Data:</strong> ${dataOdierna}<br><strong>Rif:</strong> ${projectData.projectCode||'N/D'}</p><hr style="margin:20px 0;border:0;border-top:1px solid #ddd;"><table style="width:100%;border-collapse:collapse;margin-top:20px"><thead><tr><th style="border:1px solid #ddd;padding:8px;text-align:left;font-size:10pt;background-color:#eff6ff;color:#1e3a8a;font-weight:bold;">Codice Articolo</th><th style="border:1px solid #ddd;padding:8px;text-align:left;font-size:10pt;background-color:#eff6ff;color:#1e3a8a;font-weight:bold;">Descrizione</th><th style="border:1px solid #ddd;padding:8px;text-align:left;font-size:10pt;background-color:#eff6ff;color:#1e3a8a;font-weight:bold;">Quantità</th><th style="border:1px solid #ddd;padding:8px;text-align:right;font-size:10pt;background-color:#eff6ff;color:#1e3a8a;font-weight:bold;">Prezzo Unitario</th><th style="border:1px solid #ddd;padding:8px;text-align:right;font-size:10pt;background-color:#eff6ff;color:#1e3a8a;font-weight:bold;">Prezzo Totale</th></tr></thead><tbody>${data.articoli.map(art=>`<tr><td style="border:1px solid #ddd;padding:8px;font-size:10pt;">${art.colonnaI}</td><td style="border:1px solid #ddd;padding:8px;font-size:10pt;">${art.colonnaJ}</td><td style="border:1px solid #ddd;padding:8px;font-size:10pt;">${art.colonnaK}</td><td style="border:1px solid #ddd;padding:8px;text-align:right;font-size:10pt;">€ ${art.colonnaT.toLocaleString('it-IT',{minimumFractionDigits:2})}</td><td style="border:1px solid #ddd;padding:8px;text-align:right;font-size:10pt;">€ ${art.colonnaU.toLocaleString('it-IT',{minimumFractionDigits:2})}</td></tr>`).join('')}<tr style="font-weight:bold;background-color:#eff6ff;"><td colspan="4" style="border:1px solid #ddd;padding:8px;text-align:right;font-size:10pt;">TOTALE COMPLESSIVO</td><td style="border:1px solid #ddd;padding:8px;text-align:right;font-size:10pt;">€ ${data.totaleU.toLocaleString('it-IT',{minimumFractionDigits:2})}</td></tr></tbody></table></div>`;
}

async function generateFiles() {
    if (!document.getElementById('fileGenClientName').value.trim()) { alert("Inserisci il Nome Cliente."); return; }
    const btn = document.getElementById('fileGenerateBtn');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<svg class="w-5 h-5 mr-3 loading" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Generazione...`;
    await new Promise(resolve => setTimeout(resolve, 500));
    const projectData = { cliente: document.getElementById('fileGenClientName').value, projectCode: document.getElementById('projectCode').value, extractedData: extractedData };
    generatedFileData = { type: 'offer', name: `Offerta_${projectData.cliente.replace(/[\s\/]/g, '_')}.html`, content: generateCommercialOffer(projectData) };
    displayGeneratedFiles();
    document.getElementById('fileGeneratorForm').classList.add('hidden');
    document.getElementById('generatedFiles').classList.remove('hidden');
    btn.disabled = false;
    btn.innerHTML = "Genera Offerta";
}

function displayGeneratedFiles() {
    const filesList = document.getElementById('filesList');
    const file = generatedFileData;
    filesList.innerHTML = `<div class="border border-blue-200 rounded-lg p-4 bg-blue-50"><div class="flex items-center mb-3"><svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span class="font-semibold text-blue-800 ml-2 text-lg">Offerta</span></div><p class="text-sm text-gray-700 mb-4">${file.name}</p><div class="grid grid-cols-2 gap-3"><button onclick="downloadFile()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Download</button><button onclick="copyFileContent(this)" class="px-4 py-2 bg-gray-200 rounded-lg">Copia</button></div></div>`;
    previewFile();
}

function previewFile() {
    const file = generatedFileData;
    const previewContainer = document.getElementById('filesPreview');
    previewContainer.innerHTML = `<div class="bg-white border rounded-lg p-6"><h4 class="font-medium text-gray-800 mb-4">Anteprima:</h4><div id="preview-content-wrapper" class="bg-white border rounded max-h-[40rem] overflow-y-auto"></div></div>`;
    document.getElementById('preview-content-wrapper').innerHTML = file.content;
}

function downloadFile() {
    const file = generatedFileData;
    const fullHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Offerta</title></head><body>${file.content}</body></html>`;
    const blob = new Blob([fullHtml], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = file.name; a.click(); URL.revokeObjectURL(url);
}

function copyFileContent(buttonElement) {
    const file = generatedFileData;
    const originalText = buttonElement.textContent;
    const blob = new Blob([file.content], { type: 'text/html' });
    const item = new ClipboardItem({ 'text/html': blob });
    navigator.clipboard.write([item]).then(() => {
        buttonElement.textContent = 'Copiato!';
        setTimeout(() => { buttonElement.textContent = originalText; }, 2500);
    }).catch(err => alert('Errore: ' + err.message));
}

function removeAnalysisFile() {
    analysisFile = null;
    extractedData = {};
    document.getElementById('analysisUpload').value = '';
    document.getElementById('uploadedAnalysisFile').classList.add('hidden');
    document.getElementById('fileGenerateBtn').disabled = true;
}

function resetFileGenerator() {
    document.getElementById('fileGenClientName').value = '';
    document.getElementById('projectCode').value = '';
    removeAnalysisFile();
    generatedFileData = null;
    document.getElementById('generatedFiles').classList.add('hidden');
    document.getElementById('fileGeneratorForm').classList.remove('hidden');
}

        // --- GLOBAL INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            // Set default view
            showIntro();
            
            // Add click handler for home button
            document.getElementById('homeBtn').addEventListener('click', showIntro);
            
            // Add wizard file upload handlers
            document.getElementById('photoUpload').addEventListener('change', async function(event) {
                await handleSpaceFileUpload(event, 'photo');
            });

            document.getElementById('planUpload').addEventListener('change', async function(event) {
                await handleSpaceFileUpload(event, 'plan');
            });
        });
    </script>
</body>
</html>
